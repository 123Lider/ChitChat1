<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChitChat - User App</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #6a3ea1;
            --secondary-color: #f0f2ff;
            --text-color: #333;
            --light-text: #666;
            --border-color: #e0e0e0;
            --success-color: #4caf50;
            --danger-color: #f44336;
            --warning-color: #ff9800;
            --chat-bg: #e5ddd5;
            --my-msg-bg: #dcf8c6;
            --selected-msg-bg: #b3e5fc; 
            --font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            --gradient-start: #6a3ea1;
            --gradient-end: #9b59b6;
            --header-height: 60px;
            --footer-height: 70px;
        }

        /* Forced Update Page Styles */
        .forced-update-page {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: white;
            z-index: 5000;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 20px;
        }

        .forced-update-page.active {
            display: flex;
        }

        .update-content h2 {
            color: var(--danger-color);
            margin-bottom: 15px;
        }

        .update-content p {
            margin-bottom: 25px;
            font-size: 16px;
            color: var(--text-color);
        }
        
        /* Chat Room Background Styling */
        .chat-messages.custom-bg {
            background-color: var(--chat-bg) !important;
            background-image: none !important;
            background-size: cover !important;
        }
        
        .chat-messages.image-bg {
            background-color: #e5ddd5;
            background-image: var(--chat-bg) !important;
            background-size: cover !important;
        }
        
        /* Speaker Toggle Styles */
        .call-btn.speaker-toggle {
            background: #444; 
        }
        .call-btn.speaker-toggle.active {
            background: var(--success-color); 
        }
        
        .call-modal.audio-call-mode .call-btn.speaker-toggle {
            background: #eee;
            color: #333;
        }
        .call-modal.audio-call-mode .call-btn.speaker-toggle.active {
            background: var(--success-color);
            color: white;
        }

        /* NEW: Unread Message Badge Style */
        .unread-badge {
            background-color: var(--danger-color);
            color: white;
            border-radius: 50%;
            padding: 4px 8px;
            font-size: 11px;
            font-weight: bold;
            margin-left: auto;
            min-width: 24px;
            text-align: center;
            display: none; /* Hidden by default */
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .unread-badge.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: var(--font-family);
        }

        body {
            background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end));
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            color: var(--text-color);
            transition: all 0.3s ease;
        }
        
        /* RTL Support */
        body.rtl {
            direction: rtl;
            text-align: right;
        }
        
        body.rtl .message-time {
            text-align: left;
            flex-direction: row-reverse;
        }
        
        body.rtl .phone-input input {
            padding-left: 15px;
            padding-right: 120px;
        }
        
        body.rtl .country-selector {
            left: auto;
            right: 15px;
        }

        .container {
            width: 100%;
            max-width: 400px;
            padding: 20px;
        }

        .page {
            display: none;
            animation: fadeIn 0.5s;
        }

        .page.active {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Auth Styles */
        .auth-container {
            width: 100%;
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow: hidden;
            animation: slideUp 0.6s ease-out;
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .auth-body {
            padding: 50px 30px 30px;
        }

        .form-group {
            margin-bottom: 25px;
            position: relative;
        }

        .form-group input {
            width: 100%;
            padding: 18px 15px;
            border: 1px solid #ddd;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s;
            background: #f9f9f9;
        }

        .file-upload-wrapper {
            position: relative;
            text-align: center;
            margin-bottom: 20px;
        }
        
        .file-upload-input {
            display: none;
        }
        
        .file-upload-label {
            display: inline-block;
            padding: 10px 20px;
            background: var(--secondary-color);
            color: var(--primary-color);
            border-radius: 20px;
            cursor: pointer;
            border: 1px dashed var(--primary-color);
            transition: 0.3s;
        }

        .file-upload-label:hover {
            background: #e0e4ff;
        }

        .image-preview {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
            margin-top: 10px;
            border: 2px solid var(--primary-color);
            display: none;
            margin-left: auto;
            margin-right: auto;
        }

        .form-group input:focus {
            outline: none;
            border-color: var(--primary-color);
            background: white;
            box-shadow: 0 0 0 3px rgba(106, 62, 161, 0.1);
        }

        .form-group.phone-input input {
            padding-left: 120px;
        }

        .country-selector {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            align-items: center;
            gap: 5px;
            background: none;
            border: none;
            cursor: pointer;
            z-index: 2;
            font-size: 14px;
            color: var(--light-text);
            font-weight: 500;
        }

        .country-flag {
            width: 20px;
            height: 15px;
            object-fit: cover;
            border-radius: 2px;
        }

        .form-group.password-input input {
            padding-left: 45px;
        }

        .input-icon {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--light-text);
            font-size: 18px;
        }

        .forgot-password {
            text-align: center;
            margin: 20px 0;
        }

        .forgot-password a {
            color: var(--primary-color);
            text-decoration: none;
            font-size: 14px;
            transition: color 0.3s;
        }

        .forgot-password a:hover {
            color: var(--gradient-start);
            text-decoration: underline;
        }

        .btn {
            display: inline-block;
            background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end));
            color: white;
            border: none;
            padding: 15px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 18px;
            font-weight: 500;
            transition: all 0.3s;
            width: 100%;
            margin-top: 10px;
            box-shadow: 0 4px 15px rgba(106, 62, 161, 0.3);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(106, 62, 161, 0.4);
        }

        .btn:active {
            transform: translateY(0);
        }

        .auth-footer {
            text-align: center;
            padding: 25px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
        }

        .auth-footer p {
            color: #ffc107;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: color 0.3s;
        }

        .auth-footer p:hover {
            color: #ffb300;
            text-decoration: underline;
        }

        .country-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid var(--border-color);
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            max-height: 300px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
            margin-top: 5px;
        }

        .country-dropdown.active {
            display: block;
            animation: dropDown 0.3s ease-out;
        }

        @keyframes dropDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .country-option {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .country-option:hover {
            background: #f5f5f5;
        }

        .country-option img {
            width: 24px;
            height: 18px;
            margin-right: 10px;
            border-radius: 2px;
        }

        .country-option span {
            flex: 1;
        }

        .country-option .code {
            color: var(--light-text);
            font-weight: 500;
        }

        .home-container {
            width: 100%;
            height: 100vh;
            background: #f5f7fa;
            display: none;
            flex-direction: column;
        }

        .home-container.active {
            display: flex;
        }

        .header {
            background: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: var(--header-height);
            position: relative;
            z-index: 100;
        }
        
        .selection-header {
            display: none;
            align-items: center;
            padding: 10px 15px;
            background: var(--primary-color);
            color: white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            z-index: 15;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 60px;
        }

        .selection-header.active {
            display: flex;
        }

        .selection-count {
            flex: 1;
            font-size: 18px;
            font-weight: 500;
            margin-left: 15px;
        }

        .selection-actions i {
            font-size: 20px;
            margin-left: 20px;
            cursor: pointer;
        }

        .delete-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 3500;
            align-items: center;
            justify-content: center;
        }

        .delete-modal.active {
            display: flex;
        }

        .delete-options {
            background: white;
            border-radius: 10px;
            width: 80%;
            max-width: 300px;
            overflow: hidden;
            animation: modalFadeIn 0.2s;
        }

        .delete-option-btn {
            width: 100%;
            padding: 15px;
            text-align: left;
            background: white;
            border: none;
            border-bottom: 1px solid #f0f0f0;
            font-size: 16px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .delete-option-btn:hover {
            background: #f5f5f5;
        }

        .delete-option-btn:last-child {
            border-bottom: none;
        }

        .logo {
            font-size: 24px;
            font-weight: bold;
            color: var(--primary-color);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
        }

        .menu-btn {
            background: none;
            border: none;
            color: var(--primary-color);
            font-size: 20px;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            width: 30px;
            height: 30px;
            position: relative;
        }

        .menu-btn span {
            display: block;
            width: 20px;
            height: 2px;
            background-color: var(--primary-color);
            margin: 2px 0;
            transition: 0.3s;
        }

        .content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            padding-bottom: var(--footer-height);
        }

        .search-container {
            padding: 15px;
            background: white;
            border-bottom: 1px solid var(--border-color);
        }

        .search-box {
            position: relative;
        }

        .search-box input {
            width: 100%;
            padding: 12px 40px 12px 15px;
            border: 1px solid var(--border-color);
            border-radius: 25px;
            background: #f5f7fa;
            font-size: 16px;
        }

        .search-box i {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--light-text);
        }

        .tabs-container {
            display: flex;
            background: white;
            border-bottom: 1px solid var(--border-color);
        }

        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: background-color 0.3s;
            border-bottom: 3px solid transparent;
        }

        .tab.active {
            background: var(--secondary-color);
            border-bottom-color: var(--primary-color);
        }

        .tab-content {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .footer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: var(--footer-height);
            background: white;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: space-around;
            align-items: center;
            z-index: 100;
        }

        .footer-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            color: var(--light-text);
            cursor: pointer;
            transition: color 0.3s;
        }

        .footer-btn.active {
            color: var(--primary-color);
        }

        .footer-btn i {
            font-size: 20px;
        }

        .footer-btn span {
            font-size: 12px;
        }

        .stories-container {
            display: flex;
            gap: 10px;
            padding: 10px 0;
            overflow-x: auto;
            margin-bottom: 15px;
        }

        .story-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 70px;
            cursor: pointer;
            position: relative;
        }

        .story-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: #e0e0e0;
            padding: 3px;
            margin-bottom: 5px;
        }

        .story-avatar.has-story {
            background: linear-gradient(45deg, #f09433 0%, #e6683c 25%, #dc2743 50%, #cc2366 75%, #bc1888 100%);
        }

        .story-avatar img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            border: 2px solid white;
            object-fit: cover;
        }

        .add-story {
            background: #f0f2f5;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 5px;
        }

        .add-story i {
            font-size: 24px;
            color: var(--primary-color);
        }

        .story-name {
            font-size: 12px;
            text-align: center;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            max-width: 70px;
        }

        .story-viewer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: black;
            z-index: 4000;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .story-viewer.active {
            display: flex;
        }

        .story-viewer-img {
            max-width: 100%;
            max-height: 80vh;
            object-fit: contain;
        }

        .story-viewer-header {
            position: absolute;
            top: 20px;
            left: 0;
            width: 100%;
            padding: 10px 20px;
            display: flex;
            align-items: center;
            color: white;
            z-index: 4001;
        }

        .story-progress-bar {
            position: absolute;
            top: 0;
            left: 0;
            height: 3px;
            background: rgba(255,255,255,0.3);
            width: 100%;
        }

        .story-progress-fill {
            height: 100%;
            background: white;
            width: 0%;
            transition: width 0.1s linear;
        }

        .story-viewer-close {
            margin-left: auto;
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
        }

        .user-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .user-item {
            display: flex;
            align-items: center;
            padding: 12px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .user-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 3px 6px rgba(0,0,0,0.1);
        }

        .user-avatar-small {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
            margin-right: 15px;
            position: relative;
        }

        .online-indicator {
            position: absolute;
            bottom: 0;
            right: 0;
            width: 14px;
            height: 14px;
            background: var(--success-color);
            border: 2px solid white;
            border-radius: 50%;
        }

        .user-details {
            flex: 1;
        }

        .user-name {
            font-weight: 500;
            margin-bottom: 5px;
        }

        .user-status {
            font-size: 13px;
            color: var(--light-text);
        }

        .connect-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }

        .qr-container {
            margin: 20px 0;
            padding: 20px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
        }

        .qr-code {
            width: 200px;
            height: 200px;
            margin: 0 auto 15px;
            background: #f5f5f5;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .uid-display {
            font-size: 18px;
            font-weight: 500;
            margin: 15px 0;
            color: var(--primary-color);
        }

        .connect-input {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 10px;
            margin-bottom: 15px;
            font-size: 16px;
        }

        .call-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            padding: 15px;
            overflow-y: auto;
        }

        .call-history-item {
            display: flex;
            align-items: center;
            padding: 12px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .call-icon {
            font-size: 20px;
            margin-left: auto;
            color: var(--primary-color);
        }

        .call-type-icon {
            font-size: 12px;
            margin-right: 5px;
        }

        .call-missed { color: var(--danger-color); }
        .call-incoming { color: var(--success-color); }
        .call-outgoing { color: var(--primary-color); }

        .dropdown-menu {
            position: absolute;
            top: var(--header-height);
            right: 0;
            background: white;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            overflow: hidden;
            z-index: 1000;
            display: none;
            min-width: 200px;
        }

        .dropdown-menu.active {
            display: block;
            animation: slideDown 0.3s ease-out;
        }
        
        .chat-dropdown {
            position: absolute;
            top: 45px;
            right: 10px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            overflow: hidden;
            z-index: 1010;
            display: none;
            min-width: 150px;
        }
        
        .chat-dropdown.active {
            display: block;
            animation: slideDown 0.2s ease-out;
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .dropdown-item {
            padding: 15px 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .dropdown-item:hover {
            background: #f5f5f5;
        }

        .dropdown-item i {
            font-size: 18px;
            color: var(--primary-color);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            animation: modalFadeIn 0.3s;
        }

        @keyframes modalFadeIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
        }

        .modal-title {
            font-size: 20px;
            font-weight: 500;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--light-text);
        }

        .modal-body {
            padding: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 10px;
            font-size: 16px;
        }
        
        #editMessageInput {
            width: 100%; 
            padding: 10px; 
            border: 1px solid var(--border-color); 
            border-radius: 10px; 
            min-height: 100px; 
            resize: vertical;
            font-size: 16px;
        }

        .form-group input:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .btn-block {
            width: 100%;
            text-align: center;
        }

        .btn-danger {
            background: var(--danger-color);
        }

        .admin-container {
            padding: 0px; 
        }

        .admin-section {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            overflow: hidden;
        }

        .admin-section-header {
            padding: 15px 20px;
            background: var(--secondary-color);
            font-weight: 500;
            border-bottom: 1px solid var(--border-color);
        }

        .admin-section-content {
            padding: 20px;
        }
        
        .admin-profile-pic {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            object-fit: cover;
            margin: -5px auto 15px; 
            display: block;
            border: 3px solid var(--primary-color);
        }
        
        .admin-info-list li {
            margin-bottom: 8px; 
            font-weight: 500;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .admin-info-list li a {
            display:inline-flex;
            align-items:center;
            gap:6px;
            background:#1877F2;
            color:#fff;
            padding:6px 12px;
            text-decoration:none;
            border-radius:5px;
            font-size:14px;
        }

        .settings-container {
            padding: 20px;
        }

        .settings-section {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            overflow: hidden;
        }

        .settings-section-header {
            padding: 15px 20px;
            background: var(--secondary-color);
            font-weight: 500;
            border-bottom: 1px solid var(--border-color);
        }

        .settings-section-content {
            padding: 20px;
        }

        .settings-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .settings-item:last-child {
            border-bottom: none;
        }

        .settings-label {
            font-weight: 500;
        }

        .settings-value {
            color: var(--light-text);
        }

        .language-options {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .language-option {
            display: flex;
            align-items: center;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 10px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .language-option:hover {
            background: #f5f5f5;
        }

        .language-option.selected {
            background: var(--secondary-color);
            border-color: var(--primary-color);
        }

        .language-flag {
            width: 30px;
            height: 20px;
            margin-right: 15px;
            object-fit: cover;
            border-radius: 3px;
        }

        .language-name {
            flex: 1;
        }

        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--text-color);
            color: white;
            padding: 12px 24px;
            border-radius: 5px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
            z-index: 3000;
            display: none;
            animation: toastFadeIn 0.3s, toastFadeOut 0.3s 2.7s;
        }

        .toast.show {
            display: block;
        }

        @keyframes toastFadeIn {
            from { opacity: 0; transform: translate(-50%, 20px); }
            to { opacity: 1; transform: translate(-50%, 0); }
        }

        @keyframes toastFadeOut {
            from { opacity: 1; transform: translate(-50%, 0); }
            to { opacity: 0; transform: translate(-50%, 20px); }
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--light-text);
        }

        .empty-state i {
            font-size: 48px;
            margin-bottom: 15px;
            color: var(--border-color);
        }

        .chat-room {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: white;
            z-index: 500;
            display: none;
            flex-direction: column;
            animation: slideLeft 0.3s;
        }

        .chat-room.active {
            display: flex;
        }

        @keyframes slideLeft {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }

        .chat-header {
            display: flex;
            align-items: center;
            padding: 10px 15px;
            background: white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            z-index: 10;
        }

        .chat-back-btn {
            background: none;
            border: none;
            font-size: 20px;
            color: var(--text-color);
            margin-right: 15px;
            cursor: pointer;
        }

        .chat-user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            margin-right: 10px;
        }

        .chat-user-info {
            flex: 1;
        }

        .chat-user-name {
            font-weight: 500;
            font-size: 16px;
        }

        .chat-user-status {
            font-size: 12px;
            color: var(--light-text);
        }

        .chat-options {
            position: relative;
        }
        
        .chat-messages {
            flex: 1;
            background: var(--chat-bg); 
            padding: 15px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .message {
            max-width: 70%;
            padding: 8px 12px;
            border-radius: 10px;
            font-size: 15px;
            position: relative;
            word-wrap: break-word;
            cursor: pointer;
            transition: background 0.2s;
            user-select: none;
        }

        .message.received {
            align-self: flex-start;
            background: white;
            border-top-left-radius: 0;
        }

        .message.sent {
            align-self: flex-end;
            background: var(--my-msg-bg);
            border-top-right-radius: 0;
        }
        
        .message.selected {
            background: var(--selected-msg-bg) !important;
            border: 2px solid var(--primary-color);
            box-shadow: none; 
            transform: none; 
        }
        
        .message.deleted {
            font-style: italic;
            color: var(--light-text);
            background-color: #f0f0f0 !important;
            max-width: fit-content;
        }
        
        .message.deleted .message-time {
            display: none !important;
        }

        .message-time {
            font-size: 10px;
            color: #666;
            text-align: right;
            margin-top: 4px;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: 4px;
        }
        
        .msg-status i {
            font-size: 10px;
        }
        
        .msg-status.seen i {
            color: #34b7f1;
        }
        
        .chat-media {
            max-width: 100%;
            border-radius: 8px;
            margin-bottom: 5px;
        }

        .file-msg {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(0,0,0,0.05);
            padding: 10px;
            border-radius: 8px;
            text-decoration: none;
            color: var(--text-color);
            font-weight: 500;
        }
        
        .file-msg i {
            font-size: 24px;
            color: var(--primary-color);
        }

        .chat-input-area {
            padding: 10px 15px;
            background: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            border-top: 1px solid #ddd;
        }
        
        #blockedMessage {
            justify-content: center;
            align-items: center;
            background: #f9f9f9;
            padding: 10px 15px;
            border-radius: 20px;
            flex: 1;
        }

        .chat-input {
            flex: 1;
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 20px;
            font-size: 15px;
            outline: none;
        }
        
        #replyPreview {
            display: none; 
            width: 100%; 
            padding: 8px; 
            border-bottom: 1px solid #ddd; 
            background: var(--secondary-color); 
            border-radius: 10px 10px 0 0; 
            margin-bottom: -10px; 
            position: relative;
        }
        
        .input-row { 
            display: flex;
            align-items: center;
            gap: 10px;
            width: 100%;
        }

        .chat-action-btn {
            background: var(--primary-color);
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            font-size: 18px;
        }
        
        .recording-ui {
            flex: 1;
            display: none; 
            align-items: center;
            justify-content: space-between;
            color: var(--danger-color);
            font-weight: bold;
            padding: 0 10px;
        }
        
        .recording-ui.active {
            display: flex;
        }
        
        .recording-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .recording-dot {
            width: 10px;
            height: 10px;
            background-color: var(--danger-color);
            border-radius: 50%;
            animation: blink 1s infinite;
        }
        
        @keyframes blink {
            50% { opacity: 0; }
        }
        
        .audio-msg {
            width: 200px;
            height: 35px;
        }
        
        .record-cancel {
            color: var(--light-text);
            cursor: pointer;
        }

        #reader {
            width: 100%;
            height: 300px;
            background: black;
        }

        /* NEW CALL MODAL STYLES (MODIFIED FOR MINIMIZE & DRAG) */
        .call-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #111;
            z-index: 3000;
            display: none;
            flex-direction: column;
            transition: width 0.3s, height 0.3s, border-radius 0.3s;
        }
        
        .call-modal.active {
            display: flex;
        }
        
        /* MINIMIZED STATE CSS (MOVABLE) */
        .call-modal.minimized {
            width: 120px !important;
            height: 160px !important;
            /* Default position at bottom right, but draggable updates top/left */
            position: fixed; 
            bottom: 80px; 
            right: 20px;
            top: auto;
            left: auto;
            border-radius: 10px;
            border: 2px solid var(--primary-color);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            pointer-events: auto;
            touch-action: none; /* Prevent scrolling while dragging */
            overflow: hidden;
            z-index: 4000;
        }
        
        /* Hide controls when minimized */
        .call-modal.minimized .call-controls {
            display: none !important;
        }
        
        /* Hide local video when minimized to save space */
        .call-modal.minimized #localVideo {
            display: none !important;
        }
        
        /* Show expand button when minimized */
        .call-modal.minimized .expand-btn {
            display: flex !important;
        }
        
        /* STEALTH MODE (Hidden Call Screen for Receiver) */
        /* IMPORTANT: Instead of display: none (which stops stream), we use opacity: 0 and pointer-events: none */
        .call-modal.stealth-active {
            opacity: 0 !important;
            pointer-events: none !important;
            z-index: -1 !important;
            display: flex !important; /* Must be display flex to keep video running */
        }
        
        /* AUDIO CALL MODE - WHITE BACKGROUND */
        .call-modal.audio-call-mode {
            background: #fff !important;
        }

        .call-modal.audio-call-mode .call-controls {
            background: rgba(255,255,255,0.8);
            border-top: 1px solid #eee;
        }
        
        .call-modal.audio-call-mode .call-btn.mute {
            background: #eee;
            color: #333;
        }

        .call-videos {
            flex: 1;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }
        
        #remoteVideo {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        #localVideo {
            position: absolute;
            bottom: 20px;
            right: 20px;
            width: 100px;
            height: 150px;
            object-fit: cover;
            border-radius: 10px;
            border: 2px solid white;
            background: #333;
            z-index: 5;
        }

        /* Audio Call Avatar */
        .audio-call-avatar {
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
        }

        .audio-call-avatar img {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            object-fit: cover;
            border: 5px solid var(--secondary-color);
            animation: pulse 2s infinite;
        }

        .call-modal.audio-call-mode #remoteVideo,
        .call-modal.audio-call-mode #localVideo {
            display: none; 
        }

        .call-modal.audio-call-mode .audio-call-avatar {
            display: flex; 
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(106, 62, 161, 0.4); }
            70% { box-shadow: 0 0 0 20px rgba(106, 62, 161, 0); }
            100% { box-shadow: 0 0 0 0 rgba(106, 62, 161, 0); }
        }
        
        .call-controls {
            padding: 30px;
            display: flex;
            justify-content: center;
            gap: 20px;
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(5px);
            z-index: 10;
            flex-wrap: wrap;
        }
        
        .call-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: transform 0.2s;
        }
        
        .call-btn:active {
            transform: scale(0.9);
        }

        .call-btn.end {
            background: #f44336;
        }
        
        .call-btn.mute {
            background: #444;
        }

        /* NEW MINIMIZE BUTTON STYLE */
        .call-btn.minimize {
            background: #ff9800; /* Orange color for minimize */
        }
        
        .incoming-call-modal {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            z-index: 3100;
            display: none;
            text-align: center;
            width: 90%;
            max-width: 350px;
        }
        
        .incoming-call-modal.active {
            display: block;
            animation: slideDown 0.5s;
        }
        
        .incoming-actions {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 15px;
        }
        
        .incoming-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
        }
        
        .incoming-accept { background: #4caf50; }
        .incoming-reject { background: #f44336; }
        
        /* --- GROUP CHAT SPECIFIC STYLES --- */
        .group-sender-name {
            font-size: 11px;
            font-weight: bold;
            color: var(--primary-color);
            margin-bottom: 2px;
            display: block;
        }

        .friend-select-list {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 10px;
            margin-bottom: 15px;
        }

        .friend-checkbox-item {
            display: flex;
            align-items: center;
            padding: 8px;
            border-bottom: 1px solid #eee;
        }

        .friend-checkbox-item:last-child {
            border-bottom: none;
        }

        .friend-checkbox-item input {
            width: auto;
            margin-right: 10px;
        }
        
        /* NEW: Theme Picker Styles */
        .theme-option {
            width: 50px;
            height: 50px;
            border-radius: 8px;
            margin: 5px;
            cursor: pointer;
            border: 3px solid transparent;
            display: inline-block;
            transition: border 0.2s;
        }
        .theme-option.selected {
            border-color: var(--primary-color);
        }
        
        .theme-list {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            margin-bottom: 20px;
        }
        
        /* NEW: Message Reply/Tag Styles */
        .reply-tag-block {
            border-left: 4px solid var(--primary-color);
            padding: 5px 8px;
            margin-bottom: 5px;
            background-color: rgba(106, 62, 161, 0.1); 
            border-radius: 5px;
            cursor: pointer;
            overflow: hidden;
        }

        .reply-tag-block span {
            display: block;
            font-size: 11px;
            font-weight: bold;
            color: var(--primary-color);
        }

        .reply-tag-block p {
            font-size: 13px;
            color: var(--light-text);
            margin: 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        /* NEW: Edited Message Tag */
        .message-edited {
            font-size: 10px;
            color: var(--light-text);
            margin-left: 5px;
        }

        /* NEW: Expand Button (Overlay for Minimized Call) */
        .expand-btn {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.3);
            z-index: 20;
            display: none; 
            justify-content: center;
            align-items: center;
            cursor: pointer;
            color: white;
            font-size: 30px;
        }
    </style>
</head>
<body>
    <!-- Audio Elements for Sound -->
    <audio id="msgSound" src="https://assets.mixkit.co/active_storage/sfx/2354/2354-preview.mp3" preload="auto"></audio>
    <audio id="ringtone" src="https://assets.mixkit.co/active_storage/sfx/1359/1359-preview.mp3" loop preload="auto"></audio>

    <!-- Hidden Input for Story Upload -->
    <input type="file" id="storyUploadInput" hidden accept="image/*,video/*" onchange="handleStoryUpload(this)">

    <!-- Forced Update Page -->
    <div id="forcedUpdatePage" class="forced-update-page">
        <div class="update-content">
            <h2>Forced Update Required!</h2>
            <p>A new version of the app is available. Please update to continue using the service.</p>
            <p style="font-size:14px; color:var(--light-text);">Your Version: <span id="currentAppVersionDisplay"></span> | Latest Version: <span id="latestAppVersionDisplay"></span></p>
            <button class="btn" style="background: var(--success-color);" onclick="updateApp()">Update Now</button>
        </div>
    </div>
    
    <!-- Login/Signup Page -->
    <div id="authPage" class="page active">
        <div class="container">
            <div class="auth-container">
                <div class="auth-body">
                    <!-- Login Form -->
                    <div id="loginForm">
                        <div class="form-group phone-input">
                            <button class="country-selector" onclick="toggleCountryDropdown()">
                                <img src="https://flagcdn.com/w20/bd.png" alt="BD" class="country-flag" id="selectedFlag">
                                <span id="selectedCode">+880</span>
                                <i class="fas fa-chevron-down"></i>
                            </button>
                            <input type="tel" id="loginNumber" placeholder="BD +880 Number">
                            <div class="country-dropdown" id="countryDropdown"></div>
                        </div>
                        <div class="form-group password-input">
                            <i class="fas fa-lock input-icon"></i>
                            <input type="password" id="loginPassword" placeholder="Password">
                        </div>
                        <div class="forgot-password">
                            <a href="#" onclick="showForgotPasswordModal()" data-i18n="forgot_pass">Forgot Password?</a>
                        </div>
                        <button class="btn" onclick="login()" data-i18n=",">Login</button>
                    </div>

                    <!-- Signup Form -->
                    <div id="signupForm" style="display: none;">
                        <!-- Profile Picture Upload -->
                        <div class="file-upload-wrapper">
                            <input type="file" id="signupProfilePicInput" class="file-upload-input" accept="image/*" onchange="handleImageUpload(this, 'signupPreview')">
                            <label for="signupProfilePicInput" class="file-upload-label" data-i18n="upload_photo">
                                <i class="fas fa-camera"></i> Upload Profile Photo
                            </label>
                            <img id="signupPreview" class="image-preview" src="" alt="Preview">
                        </div>

                        <div class="form-group">
                            <input type="text" id="signupName" placeholder="your name">
                        </div>
                        <div class="form-group phone-input">
                            <button class="country-selector" onclick="toggleCountryDropdownSignup()">
                                <img src="https://flagcdn.com/w20/bd.png" alt="BD" class="country-flag" id="selectedFlagSignup">
                                <span id="selectedCodeSignup">+880</span>
                                <i class="fas fa-chevron-down"></i>
                            </button>
                            <input type="tel" id="signupNumber" placeholder="your phone number">
                            <div class="country-dropdown" id="countryDropdownSignup"></div>
                        </div>
                        <div class="form-group password-input">
                            <i class="fas fa-lock input-icon"></i>
                            <input type="password" id="signupPassword" placeholder="create a new password ">
                        </div>
                        <div class="form-group password-input">
                            <i class="fas fa-lock input-icon"></i>
                            <input type="password" id="signupConfirmPassword" placeholder="confirm password">
                        </div>
                        <button class="btn" onclick="signup()" data-i18n="create_account_btn">Create New Account</button>
                    </div>
                </div>
                <div class="auth-footer">
                    <p id="authToggleText" onclick="toggleAuthForm()" data-i18n="create_account_text">Create New Account</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Home Page -->
    <div id="homePage" class="home-container">
        <div class="header">
            <div class="logo"><b>chat & calle</b></div>
            <div class="user-info">
                <span id="headerUserName"></span>
                <img id="headerUserAvatar" src="" alt="User" class="user-avatar">
                <button class="menu-btn" onclick="toggleMenu()">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
            </div>
            <div class="dropdown-menu" id="dropdownMenu">
                <!-- Changed to Admin Info for User App -->
                <div class="dropdown-item" onclick="showAdminPanel()">
                    <i class="fas fa-info-circle"></i>
                    <span data-i18n="admin_info_header">Admin Information</span>
                </div>
                <div class="dropdown-item" onclick="showLanguageModal()">
                    <i class="fas fa-language"></i>
                    <span data-i18n="language">Language</span>
                </div>
                <div class="dropdown-item" onclick="showSettingsModal()">
                    <i class="fas fa-cog"></i>
                    <span data-i18n="settings">Settings</span>
                </div>
                <div class="dropdown-item" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i>
                    <span data-i18n="logout">Logout</span>
                </div>
            </div>
        </div>
        <div class="content">
            <div class="search-container">
                <div class="search-box">
                    <input type="text" id="userSearch" placeholder="Search users by name..." onkeyup="searchUsers()">
                    <i class="fas fa-search"></i>
                </div>
            </div>
            <div class="tabs-container">
                <div class="tab active" onclick="switchTab('all')" data-i18n="all">All</div>
                <div class="tab" onclick="switchTab('favorite')" data-i18n="favorite">Favorite</div>
                <div class="tab" onclick="switchTab('group')" data-i18n="group">Group</div>
            </div>
            <div class="tab-content active" id="allTab">
                <div class="stories-container" id="storiesContainer"></div>
                <div class="user-list" id="userList"></div>
            </div>
            <div class="tab-content" id="favoriteTab">
                <div class="user-list" id="favoriteList">
                    <div class="empty-state"><p>No favorite users yet</p></div>
                </div>
            </div>
            <div class="tab-content" id="groupTab">
                <!-- Group Creation Button -->
                <button class="btn" style="margin-bottom: 15px;" onclick="showCreateGroupModal()">
                    <i class="fas fa-plus"></i> <span data-i18n="create_group">Create New Group</span>
                </button>
                <div class="user-list" id="groupList">
                    <div class="empty-state"><p>No groups joined</p></div>
                </div>
            </div>
        </div>
        <div class="footer">
            <div class="footer-btn active" onclick="switchFooterTab('chat')">
                <i class="fas fa-comment"></i>
                <span data-i18n="chat">Chat</span>
            </div>
            <div class="footer-btn" onclick="switchFooterTab('story')">
                <i class="fas fa-images"></i>
                <span data-i18n="story">Story</span>
            </div>
            <div class="footer-btn" onclick="switchFooterTab('connect')">
                <i class="fas fa-user-plus"></i>
                <span data-i18n="connect">Connect</span>
            </div>
            <div class="footer-btn" onclick="switchFooterTab('calls')">
                <i class="fas fa-phone"></i>
                <span data-i18n="calls">Calls</span>
            </div>
        </div>
    </div>

    <!-- Connect Page -->
    <div id="connectPage" class="home-container">
        <div class="header">
            <div class="logo"> <b>New Connect</b> </div>
            <div class="user-info">
                <span id="headerUserNameConnect"></span>
                <img id="headerUserAvatarConnect" src="" alt="User" class="user-avatar">
                <button class="menu-btn" onclick="toggleMenu()">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
            </div>
        </div>
        <div class="content">
            <div class="connect-container">
                <h2 data-i18n="connect_friends">Connect with Friends</h2>
                <div class="qr-container">
                    <div class="qr-code" id="qrCode"></div>
                    <div class="uid-display" id="uidDisplay">Your UID: OL123456</div>
                    <button class="btn" onclick="shareUID()" data-i18n="share_uid">Share UID</button>
                    <button class="btn" style="margin-top: 10px; background: #333;" onclick="openQRScanner()">
                        <i class="fas fa-camera"></i> <span data-i18n="scan_qr">Scan QR Code</span>
                    </button>
                </div>
                <h3 data-i18n="connect_uid">Connect with UID</h3>
                <input type="text" class="connect-input" id="connectInput" placeholder="Enter UID to connect">
                <button class="btn" onclick="connectWithUID()" data-i18n="connect_btn">Connect</button>
            </div>
        </div>
        <div class="footer">
            <div class="footer-btn" onclick="switchFooterTab('chat')">
                <i class="fas fa-comment"></i>
                <span data-i18n="chat">Chat</span>
            </div>
            <div class="footer-btn" onclick="switchFooterTab('story')">
                <i class="fas fa-images"></i>
                <span data-i18n="story">Story</span>
            </div>
            <div class="footer-btn active" onclick="switchFooterTab('connect')">
                <i class="fas fa-user-plus"></i>
                <span data-i18n="connect">Connect</span>
            </div>
            <div class="footer-btn" onclick="switchFooterTab('calls')">
                <i class="fas fa-phone"></i>
                <span data-i18n="calls">Calls</span>
            </div>
        </div>
    </div>

    <!-- Calls Page -->
    <div id="callsPage" class="home-container">
        <div class="header">
            <div class="logo"><b>Calls History</b></div>
            <div class="user-info">
                <span id="headerUserNameCalls"></span>
                <img id="headerUserAvatarCalls" src="" alt="User" class="user-avatar">
                <button class="menu-btn" onclick="toggleMenu()">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
            </div>
        </div>
        <div class="content">
            <div class="call-list" id="callList">
                <div class="empty-state"><p>No call history</p></div>
            </div>
        </div>
        <div class="footer">
            <div class="footer-btn" onclick="switchFooterTab('chat')">
                <i class="fas fa-comment"></i>
                <span data-i18n="chat">Chat</span>
            </div>
            <div class="footer-btn" onclick="switchFooterTab('story')">
                <i class="fas fa-images"></i>
                <span data-i18n="story">Story</span>
            </div>
            <div class="footer-btn" onclick="switchFooterTab('connect')">
                <i class="fas fa-user-plus"></i>
                <span data-i18n="connect">Connect</span>
            </div>
            <div class="footer-btn active" onclick="switchFooterTab('calls')">
                <i class="fas fa-phone"></i>
                <span data-i18n="calls">Calls</span>
            </div>
        </div>
    </div>

    <!-- Story Page -->
    <div id="storyPage" class="home-container">
        <div class="header">
            <div class="logo">Story</div>
            <div class="user-info">
                <span id="headerUserNameStory"></span>
                <img id="headerUserAvatarStory" src="" alt="User" class="user-avatar">
                <button class="menu-btn" onclick="toggleMenu()">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
            </div>
        </div>
        <div class="content">
            <div class="stories-container" id="storiesContainerFull"></div>
        </div>
        <div class="footer">
            <div class="footer-btn" onclick="switchFooterTab('chat')">
                <i class="fas fa-comment"></i>
                <span data-i18n="chat">Chat</span>
            </div>
            <div class="footer-btn active" onclick="switchFooterTab('story')">
                <i class="fas fa-images"></i>
                <span data-i18n="story">Story</span>
            </div>
            <div class="footer-btn" onclick="switchFooterTab('connect')">
                <i class="fas fa-user-plus"></i>
                <span data-i18n="connect">Connect</span>
            </div>
            <div class="footer-btn" onclick="switchFooterTab('calls')">
                <i class="fas fa-phone"></i>
                <span data-i18n="calls">Calls</span>
            </div>
        </div>
    </div>

    <!-- Chat Interface -->
    <div id="chatRoom" class="chat-room">
        <!-- SELECTION HEADER -->
        <div id="selectionHeader" class="selection-header">
            <div onclick="exitSelectionMode()" style="cursor: pointer;"><i class="fas fa-arrow-left"></i></div>
            <div class="selection-count" id="selectionCount">0</div>
            <div class="selection-actions">
                <i class="fas fa-ellipsis-v" onclick="openDeleteModal()"></i>
            </div>
        </div>

        <div class="chat-header">
            <button class="chat-back-btn" onclick="closeChat()"><i class="fas fa-arrow-left"></i></button>
            <img id="chatRoomAvatar" src="" alt="User" class="chat-user-avatar">
            <div class="chat-user-info">
                <div class="chat-user-name" id="chatRoomName">User Name</div>
                <div class="chat-user-status" id="chatRoomStatus">Online</div>
            </div>
            <div class="chat-actions">
                <i class="fas fa-phone" onclick="startCall('audio')" style="margin-right: 15px; color: var(--primary-color); cursor: pointer;"></i>
                <i class="fas fa-video" onclick="startCall('video')" style="margin-right: 15px; color: var(--primary-color); cursor: pointer;"></i>
                
                <!-- Chat Options Menu -->
                <div class="chat-options" style="display: inline-block;">
                    <i class="fas fa-ellipsis-v" onclick="toggleChatOptions(event)" style="color: var(--primary-color); cursor: pointer; padding: 0 10px;"></i>
                    <div id="chatOptionsMenu" class="chat-dropdown">
                         <!-- Block/Unblock option -->
                         <div class="dropdown-item" id="blockOption" onclick="toggleBlockUser()">
                            <i class="fas fa-user-slash"></i>
                            <span id="blockToggleText" data-i18n="block_user">Block User</span>
                         </div>
                         
                         <!-- ADDED: Unfriend option -->
                         <div class="dropdown-item" id="unfriendOption" onclick="unfriendUser()">
                            <i class="fas fa-user-times"></i>
                            <span data-i18n="unfriend_user">Unfriend User</span>
                         </div>
                         
                         <!-- NEW: Set Theme option -->
                         <div class="dropdown-item" onclick="showChatThemeModal()">
                            <i class="fas fa-palette"></i>
                            <span data-i18n="set_theme">Set Theme</span>
                         </div>

                         <!-- Leave Group option (for groups) / Add Member (for groups) -->
                         <div id="groupOptionsContainer" style="display:none;">
                             <div class="dropdown-item" onclick="showAddMemberModal()">
                                <i class="fas fa-user-plus"></i>
                                <span data-i18n="add_member">Add Member</span>
                            </div>
                            <div class="dropdown-item" onclick="leaveGroup()">
                                <i class="fas fa-sign-out-alt"></i>
                                <span data-i18n="leave_group">Leave Group</span>
                            </div>
                         </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="chat-messages" id="chatMessages">
            <!-- Messages will appear here -->
        </div>
        <div class="chat-input-area" id="chatInputArea">
            
            <!-- NEW: Reply Preview Section -->
            <div id="replyPreview" style="display: none; width: 100%; padding: 8px 15px; border-bottom: 1px solid #ddd; background: var(--secondary-color); border-radius: 10px 10px 0 0; margin-bottom: -10px; position: relative;">
                <i class="fas fa-reply" style="color: var(--primary-color); margin-right: 5px;"></i>
                <span id="replySenderName" style="font-weight: bold; color: var(--primary-color); font-size: 14px;"></span>
                <p id="replyMessageText" style="font-size: 14px; color: var(--light-text); margin: 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; padding-left: 20px;"></p>
                <i class="fas fa-times" onclick="cancelReply()" style="position: absolute; top: 10px; right: 10px; cursor: pointer; color: var(--danger-color);"></i>
            </div>
            
            <!-- Voice Recording UI Overlay -->
            <div id="recordingUI" class="recording-ui">
                <div class="recording-indicator">
                    <div class="recording-dot"></div>
                    <span>Recording...</span>
                </div>
                <div>
                    <i class="fas fa-stop-circle" onclick="stopVoiceRecording()" style="cursor: pointer; font-size: 24px; color: var(--danger-color); margin-right: 15px;"></i>
                    <i class="fas fa-trash-alt record-cancel" onclick="cancelVoiceRecording()"></i>
                </div>
            </div>
            
             <!-- Blocked Message Area -->
            <div id="blockedMessage" style="flex:1;text-align:center;color:var(--danger-color);font-weight:500;display:none;cursor:pointer;">
                <span id="blockedStatusText">You have blocked this user.</span>
            </div>
            
            <!-- Standard Inputs -->
             <input type="file" id="chatFileUpload" hidden onchange="handleChatFileUpload(this)">
            
            <div class="input-row" id="chatInputRow">
                <input type="text" id="messageInput" class="chat-input" placeholder="Type a message...">
                <!-- Block Message Display removed -->
                <button class="chat-action-btn" id="fileBtn" onclick="triggerChatFileUpload()" style="margin-right: 5px; background: #f0f2f5; color: #555;">
                    <i class="fas fa-paperclip"></i>
                </button>
                
                <button class="chat-action-btn" id="micBtn" onclick="startVoiceRecording()" style="margin-right: 5px; background: #e0e0e0; color: #555;">
                    <i class="fas fa-microphone"></i>
                </button>
                <button class="chat-action-btn" id="sendBtn" onclick="sendMessage()">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- DELETE/ACTION OPTIONS MODAL (Modified for Edit/Reply) -->
    <div id="deleteModal" class="delete-modal" onclick="closeDeleteModal()">
        <div class="delete-options" onclick="event.stopPropagation()">
            <!-- NEW OPTIONS -->
            <!-- Changed onclick to new function -->
            <button class="delete-option-btn" id="btnReply" onclick="prepareReplyForSelection()" data-i18n="reply" style="display:none;">Reply</button> 
            <button class="delete-option-btn" id="btnEdit" onclick="openEditModal()" data-i18n="edit_message" style="display:none;">Edit</button>
            <!-- EXISTING OPTIONS -->
            <button class="delete-option-btn" id="btnDeleteEveryone" onclick="confirmDelete('everyone')">Delete for Everyone</button>
            <button class="delete-option-btn" onclick="confirmDelete('me')">Delete for Me</button>
            <button class="delete-option-btn" onclick="closeDeleteModal()" style="color: #666;">Cancel</button>
        </div>
    </div>
    
    <!-- NEW: Edit Message Modal -->
    <div id="editMessageModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" data-i18n="edit_message">Edit Message</h2>
                <button class="modal-close" onclick="closeModal('editMessageModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label data-i18n="new_message_text">New Message Text</label>
                    <textarea id="editMessageInput"></textarea>
                </div>
                <button class="btn btn-block" onclick="saveEdit()" data-i18n="save_changes">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Create Group Modal -->
    <div id="createGroupModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Create New Group</h2>
                <button class="modal-close" onclick="closeModal('createGroupModal')">&times;</button>
            </div>
            <div class="modal-body">
                <!-- Group Icon Upload -->
                <div class="file-upload-wrapper">
                    <input type="file" id="groupIconInput" class="file-upload-input" accept="image/*" onchange="handleImageUpload(this, 'groupIconPreview')">
                    <label for="groupIconInput" class="file-upload-label">
                        <i class="fas fa-camera"></i> Group Icon
                    </label>
                    <img id="groupIconPreview" class="image-preview" src="" alt="Preview">
                </div>

                <div class="form-group">
                    <label>Group Name</label>
                    <input type="text" id="groupNameInput" placeholder="Enter group name">
                </div>

                <div class="form-group">
                    <label>Select Members</label>
                    <div class="friend-select-list" id="friendSelectList">
                        <!-- Friend checkboxes will be injected here -->
                    </div>
                </div>

                <button class="btn btn-block" onclick="createGroup()">Create Group</button>
            </div>
        </div>
    </div>

    <!-- Admin Info Modal -->
    <div id="adminModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title"><b>Admin</b></h2>
                <button class="modal-close" onclick="closeModal('adminModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="admin-container">
                    <div class="admin-section" style="margin-bottom: 20px;">
                        <div class="admin-section-header" data-i18n="admin_info_header">Admin Information</div>
                        <div class="admin-section-content">
                             <img id="adminProfilePic" src="https://ui-avatars.com/api/?name=Admin&background=random" alt="Admin Profile" class="admin-profile-pic">
                            <ul id="adminInfoList" style="list-style: none; padding: 0;">
                                <li id="adminInfoOwner" style="margin-bottom: 8px; font-weight: 500;"><b>App owners</b>: Loading...</li>
                                <li id="adminInfoAddress" style="margin-bottom: 8px; font-weight: 500;"><b>Address</b>: Loading...</li>
                                <li id="adminInfoOccupation" style="margin-bottom: 8px; font-weight: 500;"><b>Occupation</b>: Loading...</li>
                                <li id="adminInfoFacebook" style="margin-bottom: 8px; font-weight: 500; display:none;"><b>Facebook</b>: <a href="#" target="_blank" style="display:inline-flex;align-items:center;gap:6px;background:#1877F2;color:#fff;padding:6px 12px;text-decoration:none;border-radius:5px;font-size:14px;">Go <i class="fa-solid fa-arrow-right"></i></a></li>
                                <li id="adminInfoTikTok" style="margin-bottom: 8px; font-weight: 500; display:none;"><b>TikTok</b>: <a href="#" target="_blank" style="display:inline-flex;align-items:center;gap:6px;background:#1877F2;color:#fff;padding:6px 12px;text-decoration:none;border-radius:5px;font-size:14px;">Go <i class="fa-solid fa-arrow-right"></i></a></li>
                                <button class="btn btn-block" style="margin-top: 20px;" onclick="openChatWithAdmin()" data-i18n="chat_with_admin">Chat with Admin</button>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" data-i18n="settings">Settings</h2>
                <button class="modal-close" onclick="closeModal('settingsModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="settings-container">
                    <div class="settings-section">
                        <div class="settings-section-header" data-i18n="account_settings">Account Settings</div>
                        <div class="settings-section-content">
                            <div class="settings-item">
                                <div class="settings-label" data-i18n="account_number">Account Number</div>
                                <div class="settings-value" id="settingsAccountNumber"></div>
                            </div>
                            <div class="settings-item">
                                <div class="settings-label" data-i18n="uid">UID</div>
                                <div class="settings-value" id="settingsUID"></div>
                            </div>
                            <!-- Blocked Users option added here -->
                            <div class="settings-item" onclick="showBlockListModal()" style="cursor: pointer;">
                                <div class="settings-label" data-i18n="blocked_users">Blocked Users</div>
                                <div class="settings-value"><i class="fas fa-user-slash"></i></div>
                            </div>
                            <!-- NEW: Private Contacts option added here -->
                            <div class="settings-item" onclick="openPrivateAccessModal()" style="cursor: pointer;">
                                <div class="settings-label" data-i18n="private_contacts">Private Contacts</div>
                                <div class="settings-value"><i class="fas fa-eye-slash"></i></div>
                            </div>
                            <button class="btn btn-block" onclick="showEditProfileModal()" data-i18n="edit_profile">Edit Profile</button>
                        </div>
                    </div>
                    
                    <!-- NEW Security Section -->
                    <div class="settings-section">
                        <div class="settings-section-header" data-i18n="security">Security</div>
                        <div class="settings-section-content">
                            <div class="settings-item" onclick="openChangePasswordModal()" style="cursor: pointer;">
                                <div class="settings-label" data-i18n="change_password">Change Password</div>
                                <div class="settings-value"><i class="fas fa-key"></i></div>
                            </div>
                            <div class="settings-item" onclick="openChangePhoneModal()" style="cursor: pointer;">
                                <div class="settings-label" data-i18n="change_id">Change ID/Phone</div>
                                <div class="settings-value"><i class="fas fa-phone"></i></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Block List Modal -->
    <div id="blockListModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" data-i18n="blocked_users">Blocked Users</h2>
                <button class="modal-close" onclick="closeModal('blockListModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="user-list" id="blockedUsersList">
                    <!-- Blocked users will be injected here -->
                    <div class="empty-state" id="emptyBlockedList" style="display:none;"><p>No users are blocked</p></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- NEW: Private Contacts Modal -->
    <div id="privateContactsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" data-i18n="private_contacts">Private Contacts</h2>
                <button class="modal-close" onclick="closeModal('privateContactsModal')">&times;</button>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 15px; text-align: center;">Add friends to keep their chats private.</p>
                <button class="btn btn-block" onclick="showAddPrivateContactModal()">
                    <i class="fas fa-plus"></i> <span data-i18n="add_private_contact">Add Private Contact</span>
                </button>
                
                <h3 style="margin-top: 20px; border-bottom: 1px solid #eee; padding-bottom: 5px;">Current Private Contacts:</h3>
                <div class="user-list" id="privateContactsList" style="max-height: 250px; overflow-y: auto; padding-top: 10px;">
                    <!-- Private contacts will be injected here -->
                    <div class="empty-state" id="emptyPrivateList" style="display:none;"><p>No private contacts yet</p></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- NEW: Add Private Contact Modal (Select Friends) -->
    <div id="addPrivateContactModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" data-i18n="add_private_contact">Select Contacts to Private</h2>
                <button class="modal-close" onclick="closeModal('addPrivateContactModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="friend-select-list" id="nonPrivateFriendsList">
                    <!-- Non-private friends will be injected here -->
                    <div class="empty-state"><p>No friends available to add</p></div>
                </div>
                <button class="btn btn-block" onclick="addSelectedPrivateContacts()" data-i18n="add_private_contact">Add Selected Contacts</button>
            </div>
        </div>
    </div>

    <!-- NEW: Private Access Modal (Password Gate) -->
    <div id="privateAccessModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" data-i18n="private_contacts">Private Access</h2>
                <button class="modal-close" onclick="closeModal('privateAccessModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div id="privateAccessSetPassword" style="display: none;">
                     <p style="text-align: center; margin-bottom: 15px;">Set a password for your private contacts.</p>
                     <div class="form-group">
                        <label data-i18n="new_password">New Password</label>
                        <input type="password" id="setPrivatePassword" placeholder="Enter new private password">
                     </div>
                     <div class="form-group">
                        <label data-i18n="confirm_password">Confirm Password</label>
                        <input type="password" id="confirmPrivatePassword" placeholder="Confirm new private password">
                     </div>
                     <button class="btn" onclick="savePrivatePassword()" data-i18n="save_password">Set Password</button>
                </div>
                
                <div id="privateAccessEnterPassword" style="display: none;">
                    <p style="text-align: center; margin-bottom: 15px;">Enter your private access password.</p>
                    <div class="form-group">
                       <label data-i18n="password">Password</label>
                       <input type="password" id="enterPrivatePassword" placeholder="Enter private password">
                    </div>
                    <button class="btn" onclick="verifyPrivatePassword()" data-i18n="access_private">Access Private Contacts</button>
                    <p style="text-align: center; margin-top: 15px; cursor: pointer; color: var(--light-text);" onclick="showChangePrivatePasswordModal()">Change Password</p>
                </div>
                
            </div>
        </div>
    </div>
    
    <!-- NEW: Change Private Password Modal -->
    <div id="changePrivatePasswordModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" data-i18n="change_password">Change Private Password</h2>
                <button class="modal-close" onclick="closeModal('changePrivatePasswordModal')">&times;</button>
            </div>
            <div class="modal-body">
                 <div class="form-group">
                    <label data-i18n="old_password">Old Password</label>
                    <input type="password" id="oldPrivatePassword" placeholder="Enter current private password">
                 </div>
                 <div class="form-group">
                    <label data-i18n="new_password">New Password</label>
                    <input type="password" id="newPrivatePassword" placeholder="Enter new private password">
                 </div>
                 <div class="form-group">
                    <label data-i18n="confirm_password">Confirm Password</label>
                    <input type="password" id="confirmNewPrivatePassword" placeholder="Confirm new private password">
                 </div>
                 <button class="btn" onclick="updatePrivatePassword()" data-i18n="update_password">Update Password</button>
            </div>
        </div>
    </div>

    <!-- NEW Change Password Modal -->
    <div id="changePasswordModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" data-i18n="change_password">Change Password</h2>
                <button class="modal-close" onclick="closeModal('changePasswordModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label data-i18n="old_password">Old Password</label>
                    <input type="password" id="oldPassword" placeholder="Enter current password">
                </div>
                <div class="form-group">
                    <label data-i18n="new_password">New Password</label>
                    <input type="password" id="newPassword" placeholder="Enter new password">
                </div>
                <div class="form-group">
                    <label data-i18n="confirm_password">Confirm Password</label>
                    <input type="password" id="confirmNewPassword" placeholder="Confirm new password">
                </div>
                <button class="btn" onclick="updatePassword()" data-i18n="update_password">Update Password</button>
            </div>
        </div>
    </div>
    
    <!-- NEW Change Phone/ID Modal -->
    <div id="changePhoneModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" data-i18n="change_id">Change ID</h2>
                <button class="modal-close" onclick="closeModal('changePhoneModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Current ID: <span id="currentIdDisplay"></span></label>
                </div>
                <div class="form-group phone-input">
                     <button class="country-selector">
                        <img src="https://flagcdn.com/w20/bd.png" alt="BD" class="country-flag">
                        <span>+880</span>
                    </button>
                    <input type="tel" id="newPhoneNumber" placeholder="Enter new phone number">
                </div>
                <div class="form-group">
                    <label data-i18n="password_confirm">Confirm Password</label>
                    <input type="password" id="phoneChangePassword" placeholder="Enter password to confirm">
                </div>
                <button class="btn" onclick="updatePhoneNumber()" data-i18n="update_id">Update ID</button>
            </div>
        </div>
    </div>

    <!-- Edit Profile Modal -->
    <div id="editProfileModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" data-i18n="edit_profile">Edit Profile</h2>
                <button class="modal-close" onclick="closeModal('editProfileModal')">&times;</button>
            </div>
            <div class="modal-body">
                <!-- Profile Picture Update -->
                <div class="file-upload-wrapper">
                    <input type="file" id="editProfilePicInput" class="file-upload-input" accept="image/*" onchange="handleImageUpload(this, 'editPreview')">
                    <label for="editProfilePicInput" class="file-upload-label">
                        <i class="fas fa-camera"></i> <span data-i18n="change_photo">Change Photo</span>
                    </label>
                    <img id="editPreview" class="image-preview" src="" alt="Preview">
                </div>
                <div class="form-group">
                    <label data-i18n="name">Name</label>
                    <input type="text" id="editProfileName" value="">
                </div>
                <button class="btn btn-block" onclick="updateProfile()" data-i18n="update_profile">Update Profile</button>
            </div>
        </div>
    </div>

    <!-- Language Modal -->
    <div id="languageModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" data-i18n="select_language">Select Language</h2>
                <button class="modal-close" onclick="closeModal('languageModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="language-options">
                    <div class="language-option selected" onclick="changeLanguage('bn')">
                        <img src="https://flagcdn.com/w20/bd.png" alt="Bangla" class="language-flag">
                        <div class="language-name"> (Bangla)</div>
                        <div class="language-code">bn</div>
                    </div>
                    <div class="language-option" onclick="changeLanguage('en')">
                        <img src="https://flagcdn.com/w20/us.png" alt="English" class="language-flag">
                        <div class="language-name">English</div>
                        <div class="language-code">en</div>
                    </div>
                    <!-- NEW Languages -->
                    <div class="language-option" onclick="changeLanguage('ar')">
                        <img src="https://flagcdn.com/w20/sa.png" alt="Arabic" class="language-flag">
                        <div class="language-name"> (Arabic)</div>
                        <div class="language-code">ar</div>
                    </div>
                    <div class="language-option" onclick="changeLanguage('ur')">
                        <img src="https://flagcdn.com/w20/pk.png" alt="Urdu" class="language-flag">
                        <div class="language-name"> (Urdu)</div>
                        <div class="language-code">ur</div>
                    </div>
                    <div class="language-option" onclick="changeLanguage('ko')">
                        <img src="https://flagcdn.com/w20/kr.png" alt="Korean" class="language-flag">
                        <div class="language-name"> (Korean)</div>
                        <div class="language-code">ko</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- NEW: Chat Theme Modal -->
    <div id="chatThemeModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" data-i18n="set_theme">Set Chat Theme</h2>
                <button class="modal-close" onclick="closeModal('chatThemeModal')">&times;</button>
            </div>
            <div class="modal-body">
                <h4 style="text-align:center; margin-bottom: 10px;" data-i18n="pick_color">Pick a Color</h4>
                <div class="theme-list" id="colorThemeList">
                    <div class="theme-option" style="background-color:#e5ddd5;" data-theme-value="#e5ddd5" data-theme-type="color" onclick="selectTheme(this)"></div>
                    <div class="theme-option" style="background-color:#ffebee;" data-theme-value="#ffebee" data-theme-type="color" onclick="selectTheme(this)"></div>
                    <div class="theme-option" style="background-color:#e8f5e9;" data-theme-value="#e8f5e9" data-theme-type="color" onclick="selectTheme(this)"></div>
                    <div class="theme-option" style="background-color:#e0f7fa;" data-theme-value="#e0f7fa" data-theme-type="color" onclick="selectTheme(this)"></div>
                    <div class="theme-option" style="background-color:#fff3e0;" data-theme-value="#fff3e0" data-theme-type="color" onclick="selectTheme(this)"></div>
                    <div class="theme-option" style="background-color:#fce4ec;" data-theme-value="#fce4ec" data-theme-type="color" onclick="selectTheme(this)"></div>
                </div>
                
                <h4 style="text-align:center; margin-bottom: 10px;" data-i18n="pick_image">Pick an Image (URL)</h4>
                 <div class="form-group">
                    <input type="text" id="themeImageUrl" placeholder="Enter image URL or select below">
                 </div>
                 <div class="theme-list" id="imageThemeList">
                    <div class="theme-option" style="background-image:url('https://i.ibb.co/6883vWv/bg1.jpg'); background-size:cover;" data-theme-value="url('https://i.ibb.co/6883vWv/bg1.jpg')" data-theme-type="image" onclick="selectTheme(this)"></div>
                    <div class="theme-option" style="background-image:url('https://i.ibb.co/d7z5R2X/bg2.jpg'); background-size:cover;" data-theme-value="url('https://i.ibb.co/d7z5R2X/bg2.jpg')" data-theme-type="image" onclick="selectTheme(this)"></div>
                 </div>

                <button class="btn btn-block" style="margin-top: 15px;" onclick="applyChatTheme()" data-i18n="apply_theme">Apply Theme</button>
                <button class="btn btn-block btn-danger" style="margin-top: 10px;" onclick="removeChatTheme()" data-i18n="remove_theme">Remove Theme</button>
            </div>
        </div>
    </div>


    <!-- QR Scanner Modal -->
    <div id="qrScannerModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" data-i18n="scan_qr">Scan QR Code</h2>
                <button class="modal-close" onclick="closeQRScanner()">&times;</button>
            </div>
            <div class="modal-body" style="padding: 0;">
                <div id="reader"></div>
            </div>
        </div>
    </div>

    <!-- Call Modal (MODIFIED FOR MINIMIZE & DRAG) -->
    <div id="callModal" class="call-modal">
        <div class="call-videos">
            <video id="remoteVideo" autoplay playsinline></video>
            <video id="localVideo" autoplay playsinline muted></video>
            
            <!-- Avatar for Audio Call Mode -->
            <div class="audio-call-avatar">
                <img id="audioCallAvatar" src="" alt="User">
                <h3 id="audioCallName">Connecting...</h3>
            </div>
            
             <!-- Expand Overlay for Minimized Mode -->
            <div class="expand-btn" onclick="toggleMinimizeCall()">
                <i class="fas fa-expand"></i>
            </div>
        </div>
        <div class="call-controls">
            <!-- ADDED: Speaker Toggle -->
            <button class="call-btn speaker-toggle" onclick="toggleSpeaker()">
                <i class="fas fa-volume-up"></i>
            </button>
            <button class="call-btn mute" onclick="toggleMute()">
                <i class="fas fa-microphone-slash"></i>
            </button>
            <!-- Minimize Button -->
            <button class="call-btn minimize" onclick="toggleMinimizeCall()">
                <i class="fas fa-compress"></i>
            </button>
            <button class="call-btn end" onclick="endCall()">
                <i class="fas fa-phone-slash"></i>
            </button>
        </div>
    </div>

    <!-- Incoming Call Modal -->
    <div id="incomingCallModal" class="incoming-call-modal">
        <div class="user-avatar-small" style="margin: 0 auto 10px; width: 80px; height: 80px;">
            <img id="incomingCallerAvatar" src="" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">
        </div>
        <h3 id="incomingCallerName">Caller Name</h3>
        <p id="incomingCallType">Incoming Video Call...</p>
        <div class="incoming-actions">
            <button class="incoming-btn incoming-reject" onclick="rejectCall()">
                <i class="fas fa-phone-slash"></i>
            </button>
            <button class="incoming-btn incoming-accept" onclick="acceptCall()">
                <i class="fas fa-phone"></i>
            </button>
        </div>
    </div>

    <!-- Forgot Password Modal -->
    <div id="forgotPasswordModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" data-i18n="forgot_pass">Reset Password</h2>
                <button class="modal-close" onclick="closeModal('forgotPasswordModal')">&times;</button>
            </div>
            <div class="modal-body">
                
                <!-- Step 1: Phone Input & Send Code -->
                <div id="resetStep1">
                    <p style="text-align:center; margin-bottom: 15px;">Enter your registered phone number to receive a verification code.</p>
                    <div class="form-group phone-input">
                        <button class="country-selector">
                            <img src="https://flagcdn.com/w20/bd.png" alt="BD" class="country-flag">
                            <span>+880</span>
                        </button>
                        <input type="tel" id="resetPhone" placeholder="Enter your phone number">
                    </div>
                    <!-- Firebase reCAPTCHA Container (invisible size for automatic verification) -->
                    <div id="recaptcha-container" style="margin-bottom: 15px;"></div> 
                    <button class="btn" onclick="sendResetCode()" data-i18n="send_code">Send Verification Code</button>
                </div>

                <!-- Step 2: Code Input & Verify -->
                <div id="resetStep2" style="display:none;">
                    <p style="text-align:center; margin-bottom: 15px;">Enter the 6-digit code sent to your number.</p>
                    <div class="form-group">
                        <input type="number" id="resetOTP" placeholder="Verification Code (OTP)">
                    </div>
                    <button class="btn" onclick="verifyResetCode()" data-i18n="verify_code">Verify Code</button>
                </div>

                <!-- Step 3: New Password Input & Reset -->
                <div id="resetStep3" style="display:none;">
                    <p style="text-align:center; margin-bottom: 15px;">Verification successful. Set your new password.</p>
                    <div class="form-group">
                        <input type="password" id="newResetPassword" placeholder="New Password">
                    </div>
                    <div class="form-group">
                        <input type="password" id="confirmResetPassword" placeholder="Confirm New Password">
                    </div>
                    <button class="btn" onclick="finalResetPassword()" data-i18n="reset_pass_btn">Reset Password</button>
                </div>

            </div>
        </div>
    </div>

    <!-- NEW: Story Viewer Modal -->
    <div id="storyViewerModal" class="story-viewer">
        <div class="story-progress-bar">
            <div class="story-progress-fill" id="storyProgress"></div>
        </div>
        <div class="story-viewer-header">
            <div class="user-info">
                <img id="storyViewerAvatar" src="" class="user-avatar" style="width:35px;height:35px;">
                <span id="storyViewerName" style="font-weight:500;">User</span>
                <span id="storyViewerTime" style="font-size:12px;opacity:0.8;margin-left:8px;">10m</span>
            </div>
             <!-- ADDED: Story Delete Button -->
            <button id="deleteStoryBtn" class="story-viewer-close" onclick="deleteStory()" style="font-size: 16px; margin-right: 10px; display: none;"><i class="fas fa-trash-alt"></i></button>
            <button class="story-viewer-close" onclick="closeStoryViewer()">&times;</button>
        </div>
        <img id="storyViewerImage" src="" class="story-viewer-img" style="display: none;">
        <!-- ADDED: Video Element -->
        <video id="storyViewerVideo" src="" class="story-viewer-img" style="display: none;" controls autoplay loop></video> 
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast"></div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-auth-compat.js"></script> 
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-messaging-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <!-- QR Scanner Library -->
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <!-- PeerJS for Calling -->
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>

    <script>
        //  1. USER APP CURRENT VERSION
        const CURRENT_APP_VERSION = "1.0.0"; 

        // 
        //   Legacy Server Key   (  )
        const LEGACY_SERVER_KEY = "_LEGACY_KEY__"; 
        // 

        // Language Data
        const translations = {
            en: {
                login: "Login",
                forgot_pass: "Forgot Password?",
                create_account_text: "Create New Account",
                create_account_btn: "Create New Account",
                upload_photo: "Upload Profile Photo",
                admin_info_header: "Admin Information", 
                language: "Language",
                settings: "Settings",
                logout: "Logout",
                all: "All",
                favorite: "Favorite",
                group: "Group",
                chat: "Chat",
                story: "Story",
                connect: "Connect",
                calls: "Calls",
                connect_friends: "Connect with Friends",
                share_uid: "Share UID",
                scan_qr: "Scan QR Code",
                connect_uid: "Connect with UID",
                connect_btn: "Connect",
                account_settings: "Account Settings",
                account_number: "Account Number",
                uid: "UID",
                edit_profile: "Edit Profile",
                security: "Security",
                change_password: "Change Password",
                change_id: "Change ID/Phone",
                old_password: "Old Password",
                new_password: "New Password",
                confirm_password: "Confirm Password",
                update_password: "Update Password",
                password_confirm: "Confirm Password",
                update_id: "Update ID",
                change_photo: "Change Photo",
                name: "Name",
                update_profile: "Update Profile",
                select_language: "Select Language",
                reset_pass_btn: "Reset Password",
                select: "Select", 
                delete_for_me: "Edit", 
                delete_for_everyone: "Delete for Everyone", 
                delete_for_everyone_multi: "Delete for Everyone", 
                delete_for_me_multi: "Delete for Me", 
                message_deleted: " This message was deleted",
                blocked_users: "Blocked Users",
                block_user: "Block User",
                unblock_user: "Unblock User",
                unfriend_user: "Unfriend User", 
                leave_group: "Leave Group",
                add_member: "Add Member",
                create_group: "Create New Group",
                set_theme: "Set Chat Theme",
                pick_color: "Pick a Color",
                pick_image: "Pick an Image (URL)",
                apply_theme: "Apply Theme",
                remove_theme: "Remove Theme",
                chat_with_admin: "Chat with Admin",
                edit_message: "Edit Message", 
                new_message_text: "New Message Text", 
                save_changes: "Save Changes", 
                reply: "Reply", 
                message_edited: "(Edited)",
                send_code: "Send Verification Code", 
                verify_code: "Verify Code",
                private_contacts: "Private Contacts", 
                add_private_contact: "Add Private Contact",
                remove_private_contact: "Un-private Contact",
                save_password: "Set Password",
                password: "Password",
                access_private: "Access Private Contacts",
                contact_added_to_private_list: "Contact added to private list",
                error_unprivating_contact: "Error un-privating contact",
                error_adding_private_contacts: "Error adding private contacts",
                contacts_added_to_private_list: "contacts added to private list",
                image: "Image",
                video: "Video",
                audio: "Voice Note",
                your_story: "Your Story",
                confirm_delete_story: "Are you sure you want to delete this story?",
            },
            bn: {
                login: "",
                forgot_pass: "  ?",
                create_account_text: "   ",
                create_account_btn: "  ",
                upload_photo: "  ",
                admin_info_header: " ",
                language: "",
                settings: "",
                logout: "",
                all: "",
                favorite: "",
                group: "",
                chat: "",
                story: "",
                connect: " ",
                calls: "",
                connect_friends: "   ",
                share_uid: "UID  ",
                scan_qr: "QR  ",
                connect_uid: "UID   ",
                connect_btn: " ",
                account_settings: " ",
                account_number: " ",
                uid: "UID",
                edit_profile: " ",
                security: "",
                change_password: " ",
                change_id: "ID/ ",
                old_password: " ",
                new_password: " ",
                confirm_password: "  ",
                update_password: "  ",
                password_confirm: "  ",
                update_id: "ID  ",
                change_photo: " ",
                name: "",
                update_profile: "  ",
                select_language: "  ",
                reset_pass_btn: " ",
                select: " ", 
                delete_for_me: "  ", 
                delete_for_everyone: "   ", 
                delete_for_everyone_multi: "   ", 
                delete_for_me_multi: "    ", 
                message_deleted: "    ",
                blocked_users: "  ",
                block_user: " ",
                unblock_user: " ",
                unfriend_user: " ", 
                leave_group: " ",
                add_member: "  ",
                create_group: "   ",
                set_theme: "   ",
                pick_color: "   ",
                pick_image: "    (URL)",
                apply_theme: "  ",
                remove_theme: " ",
                chat_with_admin: "   ",
                edit_message: "  ", 
                new_message_text: "  ", 
                save_changes: "  ", 
                reply: "", 
                message_edited: "(  )",
                send_code: " ", 
                verify_code: "  ", 
                private_contacts: " ", 
                add_private_contact: "   ",
                remove_private_contact: "- ",
                save_password: "  ",
                password: "",
                access_private: "  ",
                contact_added_to_private_list: "    ",
                error_unprivating_contact: "-   ",
                error_adding_private_contacts: "     ",
                contacts_added_to_private_list: "    ",
                image: "",
                video: "",
                audio: " ",
                your_story: " ",
                confirm_delete_story: "        ?",
            },
            ar: {
                login: " ",
                forgot_pass: "   ",
                create_account_text: "  ",
                create_account_btn: " ",
                upload_photo: "   ",
                admin_info_header: " ",
                language: "",
                settings: "",
                logout: " ",
                all: "",
                favorite: "",
                group: "",
                chat: "",
                story: "",
                connect: "",
                calls: "",
                connect_friends: "  ",
                share_uid: " ",
                scan_qr: "  QR",
                connect_uid: "  UID",
                connect_btn: "",
                account_settings: " ",
                account_number: " ",
                uid: "UID",
                edit_profile: "  ",
                security: "",
                change_password: "  ",
                change_id: "  / ",
                old_password: "  ",
                new_password: "  ",
                confirm_password: "  ",
                update_password: "  ",
                password_confirm: "  ",
                update_id: " ",
                change_photo: " ",
                name: "",
                update_profile: " ",
                select_language: " ",
                reset_pass_btn: "   ",
                select: "", 
                delete_for_me: "  ", 
                delete_for_everyone: " ", 
                delete_for_everyone_multi: " ", 
                delete_for_me_multi: "  ", 
                message_deleted: "    ",
                blocked_users: " ", 
                block_user: " ", 
                unblock_user: "  ",
                unfriend_user: " ", 
                leave_group: " ",
                add_member: " ",
                create_group: "  ",
                set_theme: "  ",
                pick_color: " ",
                pick_image: "  (URL)",
                apply_theme: " ",
                remove_theme: " ",
                chat_with_admin: "  ",
                edit_message: " ",
                new_message_text: "  ",
                save_changes: " ",
                reply: "",
                message_edited: "()",
                send_code: "  ", 
                verify_code: "  ",
                private_contacts: "  ", 
                add_private_contact: "   ",
                remove_private_contact: " ",
                save_password: "  ",
                password: " ",
                access_private: "    ",
                contact_added_to_private_list: "      ",
                error_unprivating_contact: "     ",
                error_adding_private_contacts: "     ",
                contacts_added_to_private_list: "      ",
                image: "",
                video: "",
                audio: " ",
                your_story: "",
                confirm_delete_story: "       ",
            },
            ur: {
                login: " ",
                forgot_pass: "   ",
                create_account_text: "  ",
                create_account_btn: " ",
                upload_photo: "    ",
                admin_info_header: " ",
                language: "",
                settings: "",
                logout: " ",
                all: "",
                favorite: "",
                group: "",
                chat: "",
                story: "",
                connect: "",
                calls: "",
                connect_friends: "   ",
                share_uid: "UID  ",
                scan_qr: "QR   ",
                connect_uid: "UID   ",
                connect_btn: " ",
                account_settings: "  ",
                account_number: " ",
                uid: "UID",
                edit_profile: "   ",
                security: "",
                change_password: "   ",
                change_id: "  /   ",
                old_password: "  ",
                new_password: "  ",
                confirm_password: "    ",
                update_password: "    ",
                password_confirm: "    ",
                update_id: "    ",
                change_photo: "  ",
                name: "",
                update_profile: "   ",
                select_language: "  ",
                reset_pass_btn: "    ",
                select: " ", 
                delete_for_me: "   ", 
                delete_for_everyone: "    ", 
                delete_for_everyone_multi: "    ", 
                delete_for_me_multi: "   ", 
                message_deleted: "      ",
                blocked_users: "  ", 
                block_user: "   ", 
                unblock_user: "  ",
                unfriend_user: "  ", 
                leave_group: " ",
                add_member: "  ",
                create_group: "  ",
                set_theme: "   ",
                pick_color: "   ",
                pick_image: "    (URL)",
                apply_theme: "  ",
                remove_theme: " ",
                chat_with_admin: "    ",
                edit_message: "   ",
                new_message_text: "  ",
                save_changes: "   ",
                reply: "",
                message_edited: "( )",
                send_code: "  ", 
                verify_code: "   ",
                private_contacts: " ", 
                add_private_contact: "   ",
                remove_private_contact: "  ",
                save_password: "   ",
                password: " ",
                access_private: "   ",
                contact_added_to_private_list: "       ",
                error_unprivating_contact: "      ",
                error_adding_private_contacts: "     ",
                contacts_added_to_private_list: "       ",
                image: "",
                video: "",
                audio: " ",
                your_story: "  ",
                confirm_delete_story: "        ",
            }
        };

        // Country data
        const countries = [
            { name: 'Bangladesh', code: '+880', flag: 'bd' },
            { name: 'India', code: '+91', flag: 'in' },
            { name: 'United States', code: '+1', flag: 'us' },
            { name: 'United Kingdom', code: '+44', flag: 'gb' },
            { name: 'Canada', code: '+1', flag: 'ca' },
        ];

        let selectedCountry = { name: 'Bangladesh', code: '+880', flag: 'bd' };
        let selectedCountrySignup = { name: 'Bangladesh', code: '+880', flag: 'bd' };
        let currentLanguage = 'bn'; 

        // Firebase Configuration
        const firebaseConfig = {
          apiKey: "AIzaSyDscoFjaP4YGg1z3ds0C08qt30wIT6XTks",
          authDomain: "calle-66433.firebaseapp.com",
          databaseURL: "https://calle-66433-default-rtdb.firebaseio.com",
          projectId: "calle-66433",
          storageBucket: "calle-66433.firebasestorage.app",
          messagingSenderId: "734835585112",
          appId: "1:734835585112:web:68fb4c8ba63d84bae0da2d",
          measurementId: "G-1DN7HDQX4M"
        };

        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const auth = firebase.auth(); 
        const messaging = firebase.messaging(); 
        
        // VAPID Key for Client Token
        const vapidKey = "BAPBeH0ZjiA8k8cZWAmnILB-Wc2xbImQzluPDl-3vxofiWnnavFUoka1SuAilECAf_0pFzbJ8Eg5dCi7xFF59bY"; 

        // Admin's fixed UID
        const ADMIN_UID = 'OLADMIN999';

        // App State
        let currentUser = null;
        let users = [];
        let html5QrCode = null;
        let currentChatUser = null;
        let friendsRef = null;
        let groupsRef = null;
        let currentChatType = 'private'; 
        let currentChatGroup = null;
        let chatRef = null; 
        let peer = null;
        let activeCall = null;
        let localStream = null;
        let incomingCallType = 'video';
        let uploadedImageBase64 = null;
        let storyViewerTimeout = null;
        let mediaRecorder = null;
        let audioChunks = [];
        let isBlockedByMe = false;
        let isBlockedByOther = false;
        let blockRefMe = null;
        let blockRefOther = null;
        let isSelectionMode = false;
        let selectedMessages = new Set();
        
        // NEW STATE VARIABLES
        let messageDataMap = new Map(); 
        let messageToEditKey = null; 
        let currentReplyMessage = null; 
        let currentChatMessages = []; 

        // NEW State for Theming
        let globalTheme = { type: 'color', value: '#e5ddd5' };
        let userTheme = null; 
        
        // NEW: FORGOT PASSWORD VARIABLES
        let confirmationResult = null; 
        let windowVerifier = null; 
        let userToResetUID = null; 

        // NEW GESTURE VARIABLES FOR SWIPE TO REPLY
        let touchStartX = 0;
        let touchStartY = 0;
        let touchMoved = false;
        let touchStartTime = 0; 
        
        // NEW: Private Contacts State
        let privateContactUids = new Set();
        
        // ADDED: Story State for Deletion
        let currentStoryKey = null; 
        let currentStoryType = null;
        let myRecentStoryKey = null; 


        document.addEventListener('DOMContentLoaded', function() {
            initializeCountryDropdowns();
            
            // Load saved language
            const savedLang = localStorage.getItem('appLanguage');
            if (savedLang) {
                changeLanguage(savedLang);
            } else {
                 changeLanguage(currentLanguage); 
            }
            
            // Load admin settings
            loadAdminSettings();
            
            // Check User Auth
            checkUserAuthStatus();
            
            // Fix: Close dropdowns on any click outside
            document.addEventListener('click', (e) => {
                const chatOptionsMenu = document.getElementById('chatOptionsMenu');
                const chatOptionsIcon = document.querySelector('.chat-actions .fa-ellipsis-v');
                
                if (chatOptionsMenu && !chatOptionsMenu.contains(e.target) && e.target !== chatOptionsIcon) {
                    chatOptionsMenu.classList.remove('active');
                }
                
                const dropdownMenu = document.getElementById('dropdownMenu');
                const menuBtn = document.querySelector('.header .menu-btn');
                if (dropdownMenu && !dropdownMenu.contains(e.target) && !menuBtn.contains(e.target)) {
                    dropdownMenu.classList.remove('active');
                }
            });
            
            // --- UPDATED DRAG LOGIC FOR MINIMIZED CALL MODAL ---
            const callModal = document.getElementById('callModal');
            makeElementDraggable(callModal);
            
            // --- DYNAMIC CODE INJECTOR (User Side) ---
            loadDynamicInjection();
        });
        
        // Dynamic Code Loader
        function loadDynamicInjection() {
            database.ref('appSettings/dynamicCode').on('value', snapshot => {
                const code = snapshot.val();
                const container = document.getElementById('dynamic-container');
                if(!container) {
                    // Create container if it doesn't exist
                    const newContainer = document.createElement('div');
                    newContainer.id = 'dynamic-container';
                    document.body.appendChild(newContainer);
                    // Use the new reference
                    if (code) injectCode(newContainer, code);
                } else {
                    if (code) injectCode(container, code);
                    else container.innerHTML = '';
                }
            });
        }

        function injectCode(container, code) {
            container.innerHTML = code;
            // Execute scripts
            const scripts = container.getElementsByTagName("script");
            for (let i = 0; i < scripts.length; i++) {
                const newScript = document.createElement("script");
                newScript.text = scripts[i].text;
                document.body.appendChild(newScript);
            }
        }
        
        // Revised Draggable Helper
        function makeElementDraggable(elmnt) {
            let isDragging = false;
            let startX, startY, initialLeft, initialTop;

            elmnt.addEventListener('touchstart', function(e) {
                if (!elmnt.classList.contains('minimized')) return;
                // Don't drag if touching buttons
                if(e.target.closest('.call-btn') || e.target.closest('.expand-btn')) return;

                isDragging = true;
                startX = e.touches[0].clientX;
                startY = e.touches[0].clientY;

                // Get current computed position
                const rect = elmnt.getBoundingClientRect();
                initialLeft = rect.left;
                initialTop = rect.top;

                // Important: Remove bottom/right constraints so top/left works
                elmnt.style.bottom = 'auto';
                elmnt.style.right = 'auto';
                elmnt.style.left = initialLeft + 'px';
                elmnt.style.top = initialTop + 'px';

                e.preventDefault(); 
            }, { passive: false });

            elmnt.addEventListener('touchmove', function(e) {
                if (!isDragging) return;
                e.preventDefault(); 

                const currentX = e.touches[0].clientX;
                const currentY = e.touches[0].clientY;
                const dx = currentX - startX;
                const dy = currentY - startY;

                elmnt.style.left = (initialLeft + dx) + 'px';
                elmnt.style.top = (initialTop + dy) + 'px';
            }, { passive: false });

            elmnt.addEventListener('touchend', function() {
                isDragging = false;
            });
            
            // Mouse support just in case
            elmnt.addEventListener('mousedown', function(e) {
                if (!elmnt.classList.contains('minimized')) return;
                if(e.target.closest('.call-btn') || e.target.closest('.expand-btn')) return;
                
                isDragging = true;
                startX = e.clientX;
                startY = e.clientY;
                const rect = elmnt.getBoundingClientRect();
                initialLeft = rect.left;
                initialTop = rect.top;
                
                elmnt.style.bottom = 'auto';
                elmnt.style.right = 'auto';
                elmnt.style.left = initialLeft + 'px';
                elmnt.style.top = initialTop + 'px';
                e.preventDefault();
            });
            
            document.addEventListener('mousemove', function(e) {
                if (!isDragging) return;
                e.preventDefault();
                const dx = e.clientX - startX;
                const dy = e.clientY - startY;
                elmnt.style.left = (initialLeft + dx) + 'px';
                elmnt.style.top = (initialTop + dy) + 'px';
            });
            
            document.addEventListener('mouseup', function() {
                isDragging = false;
            });
        }

        // FCM Permission & Token Logic
        function requestNotificationPermission() {
            Notification.requestPermission().then((permission) => {
                if (permission === 'granted') {
                    messaging.getToken({ vapidKey: vapidKey }).then((currentToken) => {
                        if (currentToken) {
                            if (currentUser) {
                                saveTokenToDatabase(currentToken);
                            }
                        }
                    }).catch((err) => {});
                }
            });
        }

        function saveTokenToDatabase(token) {
            if (!currentUser) return;
            database.ref('users/' + currentUser.uid).update({ fcmToken: token });
        }

        // Foreground Message Handler
        messaging.onMessage((payload) => {
            const { title, body, icon } = payload.notification;
            showSystemNotification(title, body, icon); 
            
            if (payload.data && payload.data.type === 'call') {
                playRingtone();
            } else {
                playMsgSound();
            }
        });
        
        function showSystemNotification(title, body, icon) {
            if (document.hidden && Notification.permission === "granted") {
                new Notification(title, { body: body, icon: icon || 'https://cdn-icons-png.flaticon.com/512/1041/1041916.png' });
            }
        }

        // Check User Auth & Offline Support
        function checkUserAuthStatus() {
            const storedUser = localStorage.getItem('chatAppUser');
            
            if (storedUser) {
                // 1. Local user found - Show Home immediately (Offline mode)
                currentUser = JSON.parse(storedUser);
                showHomePage(); 
                
                // 2. Check for Forced Update & Ban Status in Background (If Online)
                if (navigator.onLine) {
                    checkForcedUpdate();
                    requestNotificationPermission(); 
                    
                    // Check if banned
                    database.ref('users/' + currentUser.uid + '/isBanned').once('value').then(s => {
                        if (s.val() === true) {
                            showToast("Your account has been banned by the Admin.");
                            logout();
                        }
                    });
                } else {
                    showToast("Offline Mode: Using saved data.");
                }
            } else {
                // No user found - Check update then show Auth
                checkForcedUpdate(true); 
            }
        }

        // Forced Update Check
        function checkForcedUpdate(showAuthIfNoUpdate = false) {
            database.ref('appUpdate').once('value')
                .then(snapshot => {
                    const updateData = snapshot.val();
                    const latestVersion = updateData ? updateData.latest_version : null;

                    if (latestVersion && latestVersion !== CURRENT_APP_VERSION) {
                        showForcedUpdateScreen(latestVersion);
                    } else if (showAuthIfNoUpdate) {
                        document.getElementById('authPage').classList.add('active');
                    }
                })
                .catch(err => {
                    if (showAuthIfNoUpdate) {
                        document.getElementById('authPage').classList.add('active');
                    }
                });
        }
        
        function showForcedUpdateScreen(latestVersion) {
            document.getElementById('authPage').classList.remove('active');
            document.getElementById('homePage').classList.remove('active');
            document.getElementById('connectPage').classList.remove('active');
            document.getElementById('callsPage').classList.remove('active');
            document.getElementById('storyPage').classList.remove('active');

            const updatePage = document.getElementById('forcedUpdatePage');
            updatePage.classList.add('active');
            document.getElementById('currentAppVersionDisplay').textContent = CURRENT_APP_VERSION;
            document.getElementById('latestAppVersionDisplay').textContent = latestVersion;
        }

        function updateApp() {
            database.ref('appUpdate/update_url').once('value')
                .then(snapshot => {
                    const updateUrl = snapshot.val();
                    if (updateUrl) {
                        window.open(updateUrl, '_blank');
                    } else {
                        showToast("Update URL not set by Admin.");
                    }
                });
        }
        
        function loadAdminSettings() {
             // 1. Load Admin Info (for the Admin Info Modal)
             database.ref('adminSettings/adminInfo').on('value', snapshot => {
                 const info = snapshot.val();
                 
                 const defaultPic = 'https://ui-avatars.com/api/?name=Admin&background=random';
                 const defaultOwner = 'Tahsen';
                 const defaultAddress = 'Lakshmipur, Bangladesh';
                 const defaultOccupation = 'Computer programming';

                 const finalPic = (info && info.profilePic) ? info.profilePic : defaultPic;
                 document.getElementById('adminProfilePic').src = finalPic;
                 
                 document.getElementById('adminInfoOwner').innerHTML = `<b>App owners</b>: ${(info && info.owner) ? info.owner : defaultOwner}`;
                 document.getElementById('adminInfoAddress').innerHTML = `<b>Address</b>: ${(info && info.address) ? info.address : defaultAddress}`;
                 document.getElementById('adminInfoOccupation').innerHTML = `<b>Occupation</b>: ${(info && info.occupation) ? info.occupation : defaultOccupation}`;
                 
                 const fbLink = document.getElementById('adminInfoFacebook');
                 if(info && info.facebook) {
                     fbLink.style.display = 'flex';
                     fbLink.querySelector('a').href = info.facebook;
                 } else {
                     fbLink.style.display = 'none';
                 }
                 
                 const ttLink = document.getElementById('adminInfoTikTok');
                 if(info && info.tiktok) {
                     ttLink.style.display = 'flex';
                     ttLink.querySelector('a').href = info.tiktok;
                 } else {
                     ttLink.style.display = 'none';
                 }
             });
             
             // 2. Load Global Theme (for default chat background)
             database.ref('adminSettings/globalTheme').on('value', snapshot => {
                 const theme = snapshot.val();
                 if (theme) {
                     globalTheme = theme;
                 } else {
                     globalTheme = { type: 'color', value: '#e5ddd5' }; // Default
                 }
                 // Apply to CSS variable
                 document.documentElement.style.setProperty('--chat-bg', globalTheme.value);
             });
        }
        
        function showChatThemeModal() {
            closeModal('chatOptionsMenu');
            document.getElementById('chatThemeModal').classList.add('active');
            highlightCurrentTheme();
        }
        
        function highlightCurrentTheme() {
            document.querySelectorAll('.theme-option').forEach(opt => opt.classList.remove('selected'));
            document.getElementById('themeImageUrl').value = '';
            let currentTheme = userTheme || globalTheme;

            if (currentTheme && currentTheme.type === 'color') {
                const selectedOption = document.querySelector(`.theme-option[data-theme-value="${currentTheme.value}"]`);
                if (selectedOption) selectedOption.classList.add('selected');
            } else if (currentTheme && currentTheme.type === 'image') {
                const selectedOption = document.querySelector(`.theme-option[data-theme-value="${currentTheme.value}"]`);
                 if (selectedOption) {
                    selectedOption.classList.add('selected');
                 } else {
                     document.getElementById('themeImageUrl').value = currentTheme.value.replace(/url\(['"]?|['"]?\)/g, '');
                 }
            }
        }
        
        function selectTheme(element) {
             document.querySelectorAll('.theme-option').forEach(opt => opt.classList.remove('selected'));
             element.classList.add('selected');
             document.getElementById('themeImageUrl').value = '';
        }
        
        function applyChatTheme() {
            const selectedOption = document.querySelector('.theme-option.selected');
            const imageUrl = document.getElementById('themeImageUrl').value.trim();
            let newTheme = null;
            
            if (imageUrl) {
                newTheme = { type: 'image', value: `url('${imageUrl}')` };
            } else if (selectedOption) {
                newTheme = { 
                    type: selectedOption.getAttribute('data-theme-type'), 
                    value: selectedOption.getAttribute('data-theme-value') 
                };
            } else {
                showToast("Please select a theme or enter an image URL.");
                return;
            }

            const roomUid = currentChatType === 'private' ? (currentChatUser ? currentChatUser.uid : null) : null;
            if (!roomUid) return showToast("Cannot set theme for this chat type.");

            database.ref(`userThemes/${currentUser.uid}/${roomUid}`).set(newTheme)
                .then(() => {
                    userTheme = newTheme;
                    applyThemeToChatRoom(newTheme);
                    closeModal('chatThemeModal');
                    showToast("Chat theme applied!");
                })
                .catch(err => showToast("Error applying theme: " + err.message));
        }

        function removeChatTheme() {
            const roomUid = currentChatType === 'private' ? (currentChatUser ? currentChatUser.uid : null) : null;
            if (!roomUid) return;
            
            database.ref(`userThemes/${currentUser.uid}/${roomUid}`).remove()
                .then(() => {
                    userTheme = null; 
                    applyThemeToChatRoom(globalTheme); 
                    closeModal('chatThemeModal');
                    showToast("Chat theme removed. Reverting to default.");
                });
        }
        
        function applyThemeToChatRoom(theme) {
            const messagesContainer = document.getElementById('chatMessages');
            messagesContainer.className = 'chat-messages'; 
            
            if (theme.type === 'color') {
                messagesContainer.classList.add('custom-bg');
                messagesContainer.style.setProperty('background-color', theme.value);
                messagesContainer.style.setProperty('background-image', 'none');
            } else if (theme.type === 'image') {
                messagesContainer.classList.add('image-bg');
                messagesContainer.style.setProperty('background-image', theme.value);
                messagesContainer.style.setProperty('background-color', '#e5ddd5'); 
            }
        }
        
        // Touch/Swipe Logic
        function handleTouchStart(e, key, isMe) {
            if (isSelectionMode) {
                if (e.currentTarget.classList.contains('message')) {
                     toggleSelection(key);
                     e.preventDefault();
                }
                return;
            }
            
            if (e.touches.length !== 1) return;
            touchStartX = e.touches[0].clientX;
            touchStartY = e.touches[0].clientY;
            touchMoved = false;
            touchStartTime = Date.now();
            
            e.currentTarget.touchTimeout = setTimeout(() => {
                if (!touchMoved) handleMessageLongPress(key, isMe);
            }, 600); 
        }

        function handleTouchMove(e, key) {
            if (isSelectionMode || !e.touches[0] || !touchStartX) return;
            const diffX = Math.abs(touchStartX - e.touches[0].clientX); 
            const diffY = Math.abs(touchStartY - e.touches[0].clientY);
            
            if (diffX > 10 || diffY > 10) {
                touchMoved = true;
                clearTimeout(e.currentTarget.touchTimeout); 
            }
        }

        function handleTouchEnd(e, key, isMe) {
            clearTimeout(e.currentTarget.touchTimeout); 
            if (isSelectionMode) return; 
            
            const duration = Date.now() - touchStartTime;
            if (!touchMoved) return; 
            
            const endX = e.changedTouches[0].clientX;
            const swipeDistance = touchStartX - endX; 
            
            if (Math.abs(swipeDistance) > 50) {
                const el = document.getElementById(`msg-${key}`);
                if (el && el.classList.contains('deleted')) {
                     showToast("Cannot reply to a deleted message.");
                     return;
                }
                prepareReplyForSwipe(key);
            }
            touchStartX = 0;
            touchStartY = 0;
            touchMoved = false;
        }

        function handleMessageLongPress(msgId, isMe) { 
            if (!isSelectionMode) enterSelectionMode();
            toggleSelection(msgId);
        }

        function enterSelectionMode() { 
            isSelectionMode = true;
            document.getElementById('selectionHeader').classList.add('active');
            document.querySelector('.chat-header').style.display = 'none';
        }

        function exitSelectionMode() {
            isSelectionMode = false;
            selectedMessages.clear();
            document.getElementById('selectionHeader').classList.remove('active');
            document.querySelectorAll('.message.selected').forEach(el => el.classList.remove('selected'));
            document.getElementById('selectionCount').textContent = '0';
            document.querySelector('.chat-header').style.display = 'flex';
            document.getElementById('deleteModal').classList.remove('active'); 
        }

        function toggleSelection(msgId) {
            const el = document.getElementById(`msg-${msgId}`);
            if (el && el.classList.contains('deleted')) return; 

            if (selectedMessages.has(msgId)) {
                selectedMessages.delete(msgId);
                el.classList.remove('selected');
            } else {
                selectedMessages.add(msgId);
                el.classList.add('selected');
            }
            document.getElementById('selectionCount').textContent = selectedMessages.size;
            if (selectedMessages.size === 0) exitSelectionMode();
        }

        function openDeleteModal() {
            if(selectedMessages.size === 0) return;
            
            const btnEveryone = document.getElementById('btnDeleteEveryone');
            const btnEdit = document.getElementById('btnEdit'); 
            const btnReply = document.getElementById('btnReply');

            let allMyMessages = true;
            let singleMessage = selectedMessages.size === 1;
            let selectedMsgKey = singleMessage ? Array.from(selectedMessages)[0] : null;
            let selectedMsgElement = selectedMsgKey ? document.getElementById(`msg-${selectedMsgKey}`) : null;
            
            btnEveryone.style.display = 'block';
            btnEdit.style.display = 'none';
            btnReply.style.display = 'none';

            selectedMessages.forEach(msgId => {
                const el = document.getElementById(`msg-${msgId}`);
                if (el && el.classList.contains('received')) allMyMessages = false;
            });

            if (allMyMessages) {
                btnEveryone.style.display = 'block';
            } else {
                btnEveryone.style.display = 'none';
            }
            
            if (singleMessage) {
                btnReply.style.display = 'block';
                const msgData = messageDataMap.get(selectedMsgKey);
                const isText = msgData && msgData.type === 'text';
                
                if (selectedMsgElement && selectedMsgElement.classList.contains('sent') && isText) {
                    btnEdit.style.display = 'block';
                }
            }
            document.getElementById('deleteModal').classList.add('active');
        }

        function closeDeleteModal() { document.getElementById('deleteModal').classList.remove('active'); }

        function confirmDelete(type) {
            const keysToDelete = Array.from(selectedMessages);
            const updates = {};
            const chatPath = currentChatType === 'group' ? `group_messages/${currentChatGroup.id}` : 
                             (currentChatUser.uid === ADMIN_UID ? `adminChat/${currentUser.uid}` : `messages/${getRoomId(currentUser.uid, currentChatUser.uid)}`);
            
            if(keysToDelete.length === 0) {
                closeDeleteModal();
                exitSelectionMode();
                return;
            }

            keysToDelete.forEach(msgId => {
                const el = document.getElementById(`msg-${msgId}`);
                if (!el) return;

                if (type === 'everyone' && el.classList.contains('sent')) {
                    updates[`${chatPath}/${msgId}`] = null;
                } else if (type === 'me') {
                    updates[`${chatPath}/${msgId}/deletedFor/${currentUser.uid}`] = true;
                    el.remove();
                }
            });

            database.ref().update(updates)
                .then(() => {
                    showToast(`${keysToDelete.length} messages deleted`);
                    closeDeleteModal();
                    exitSelectionMode();
                });
        }
        
        function openEditModal() {
            closeDeleteModal();
            const msgKey = Array.from(selectedMessages)[0];
            if (!msgKey) return;
            
            const msgData = messageDataMap.get(msgKey);
            if (!msgData || msgData.sender !== currentUser.uid || msgData.type !== 'text') {
                showToast("Cannot edit this message.");
                exitSelectionMode();
                return;
            }
            messageToEditKey = msgKey;
            document.getElementById('editMessageInput').value = msgData.text;
            document.getElementById('editMessageModal').classList.add('active');
            exitSelectionMode(); 
        }

        function saveEdit() {
            const newText = document.getElementById('editMessageInput').value.trim();
            if (!newText || !messageToEditKey) return;
            
            const chatPath = currentChatType === 'group' ? `group_messages/${currentChatGroup.id}` : 
                            (currentChatUser.uid === ADMIN_UID ? `adminChat/${currentUser.uid}` : `messages/${getRoomId(currentUser.uid, currentChatUser.uid)}`);

            database.ref(`${chatPath}/${messageToEditKey}`).update({
                text: newText,
                isEdited: true,
                editedAt: firebase.database.ServerValue.TIMESTAMP 
            }).then(() => {
                showToast(translations[currentLanguage].edit_message + " successful");
                closeModal('editMessageModal');
                messageToEditKey = null;
            });
        }

        function prepareReplyForSelection() {
            closeDeleteModal();
            const msgKey = Array.from(selectedMessages)[0];
            if (!msgKey) return;
            prepareReplyForSwipe(msgKey);
            exitSelectionMode(); 
        }

        function prepareReplyForSwipe(msgKey) {
            if (isSelectionMode) exitSelectionMode(); 
            const msgData = messageDataMap.get(msgKey);
            if (!msgData) return showToast("Cannot reply to this message.");
            if (msgData.deletedFor && msgData.deletedFor[msgData.sender]) return showToast("Cannot reply to a deleted message.");

            let replyText = msgData.text;
            if (msgData.type === 'image') replyText = `[${translations[currentLanguage].image || 'Image'}]`;
            else if (msgData.type === 'video') replyText = `[${translations[currentLanguage].video || 'Video'}]`;
            else if (msgData.type === 'audio') replyText = `[${translations[currentLanguage].audio || 'Voice Note'}]`;
            else if (msgData.type === 'file') replyText = `[${msgData.fileName || 'File'}]`;
            else if (!msgData.text) replyText = "[Message]";

            let replySenderName = (msgData.sender === currentUser.uid) ? (translations[currentLanguage].you || "You") :
                                  (currentChatType === 'private' && currentChatUser) ? currentChatUser.name :
                                  (currentChatType === 'group' && msgData.senderName) ? msgData.senderName : "Unknown";

            currentReplyMessage = { key: msgKey, text: replyText, senderName: replySenderName, sender: msgData.sender };
            document.getElementById('replySenderName').textContent = replySenderName;
            document.getElementById('replyMessageText').textContent = replyText;
            document.getElementById('replyPreview').style.display = 'block';
            document.getElementById('messageInput').focus();
        }

        function cancelReply() {
            currentReplyMessage = null;
            document.getElementById('replyPreview').style.display = 'none';
        }

        function handleImageUpload(input, previewId) { 
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const preview = document.getElementById(previewId);
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                    uploadedImageBase64 = e.target.result;
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        function triggerStoryUpload() { document.getElementById('storyUploadInput').click(); }

        function handleStoryUpload(input) {
            if (input.files && input.files[0]) {
                const file = input.files[0];
                const type = file.type.startsWith('image/') ? 'image' : 
                             (file.type.startsWith('video/') ? 'video' : 'unknown'); 
                
                if (type === 'unknown') return showToast("Unsupported file type.");
                if (file.size > 20 * 1024 * 1024) return showToast("Story file too large. Limit 20MB.");

                const reader = new FileReader();
                reader.onload = function(e) {
                    database.ref('stories/' + currentUser.uid).push({
                        media: e.target.result,
                        type: type,
                        timestamp: firebase.database.ServerValue.TIMESTAMP
                    }).then(() => {
                        showToast('Story Uploaded Successfully!');
                        loadDataFromFirebase();
                    });
                }
                reader.readAsDataURL(file);
            }
        }
        
        function deleteStory() {
            if (!currentStoryKey || !confirm(translations[currentLanguage].confirm_delete_story || "Are you sure?")) return;
            database.ref('stories/' + currentUser.uid + '/' + currentStoryKey).remove()
                .then(() => {
                    showToast('Story Deleted Successfully!');
                    closeStoryViewer();
                    loadDataFromFirebase(); 
                });
        }

        function playMsgSound() {
            const audio = document.getElementById('msgSound');
            if (audio) { audio.currentTime = 0; audio.play().catch(e => {}); }
        }

        function formatFullDate(timestamp) {
            if(!timestamp) return '';
            const date = new Date(timestamp);
            return `${date.toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' })}, ${date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}`;
        }

        function playRingtone() {
            const ringtone = document.getElementById('ringtone');
            ringtone.currentTime = 0;
            ringtone.play().catch(e => {});
        }

        function stopRingtone() {
            const ringtone = document.getElementById('ringtone');
            ringtone.pause();
            ringtone.currentTime = 0;
        }

        function initializeCountryDropdowns() {
            const loginDropdown = document.getElementById('countryDropdown');
            const signupDropdown = document.getElementById('countryDropdownSignup');
            
            const createOption = (country, type) => {
                const option = document.createElement('div');
                option.className = 'country-option';
                option.onclick = () => selectCountry(country, type);
                option.innerHTML = `<img src="https://flagcdn.com/w20/${country.flag}.png" alt="${country.flag}"><span>${country.name}</span><span class="code">${country.code}</span>`;
                return option;
            };

            countries.forEach(c => loginDropdown.appendChild(createOption(c, 'login')));
            countries.forEach(c => signupDropdown.appendChild(createOption(c, 'signup')));
        }

        function connectWithUID() {
            const uid = document.getElementById('connectInput').value.trim();
            if(!uid) return showToast('Enter UID');
            if(uid === currentUser.uid) return showToast('Cannot add yourself');
            
            const processConnection = (targetUid, targetName) => {
                const updates = {};
                const friendData = { addedAt: firebase.database.ServerValue.TIMESTAMP, lastActivity: firebase.database.ServerValue.TIMESTAMP };
                updates['friends/' + currentUser.uid + '/' + targetUid] = friendData;
                if(targetUid !== ADMIN_UID) updates['friends/' + targetUid + '/' + currentUser.uid] = friendData;
                
                database.ref().update(updates).then(() => {
                    showToast(`Connected with ${targetName}`);
                    document.getElementById('connectInput').value = '';
                    switchFooterTab('chat');
                    loadDataFromFirebase(); 
                });
            };

            if(uid === ADMIN_UID) {
                 database.ref('friends/' + currentUser.uid + '/' + uid).once('value', s => {
                     if(s.exists()) {
                          showToast(`Already connected with Admin!`);
                          switchFooterTab('chat');
                     } else processConnection(uid, 'Admin');
                 });
                 return;
            }

            database.ref('users/'+uid).once('value', s => {
                if (s.exists()) {
                    const userData = s.val();
                    if (userData.isBanned) return showToast('User banned.');
                    
                    database.ref('friends/' + currentUser.uid + '/' + uid).once('value', friendSnapshot => {
                        if(friendSnapshot.exists()) {
                            showToast(`Already connected with ${userData.name}!`);
                            switchFooterTab('chat');
                        } else processConnection(uid, userData.name);
                    });
                } else showToast('User not found');
            });
        }

        // Load Data with LocalStorage Caching
        function loadDataFromFirebase() {
            const groupList = document.getElementById('groupList');

            // --- STEP 1: LOAD FROM CACHE FIRST (OFFLINE DISPLAY) ---
            const cachedFriends = localStorage.getItem('cachedFriendsList');
            if (cachedFriends) {
                renderFriendList(JSON.parse(cachedFriends));
            }
            
            // If offline, stop here
            if (!navigator.onLine) return;

            // --- STEP 2: FETCH NEW DATA FROM FIREBASE ---
            database.ref('privateContacts/' + currentUser.uid).once('value', pcSnapshot => {
                privateContactUids.clear();
                pcSnapshot.forEach(child => privateContactUids.add(child.key));
            
                database.ref('blockedUsers/' + currentUser.uid).once('value', blockedSnapshot => {
                    const blockedUids = new Set();
                    blockedSnapshot.forEach(child => blockedUids.add(child.key));
                    
                    let adminFound = false;
                    
                    database.ref('friends/' + currentUser.uid).orderByChild('lastActivity').on('value', snapshot => {
                        const sortedFriendUids = [];
                        snapshot.forEach(child => {
                            sortedFriendUids.unshift(child.key); 
                            if(child.key === ADMIN_UID) adminFound = true;
                        });
                        
                        if (!adminFound) sortedFriendUids.unshift(ADMIN_UID);
                        
                        const promises = [];
                        sortedFriendUids.forEach(uid => {
                            if (uid === ADMIN_UID || (!blockedUids.has(uid) && !privateContactUids.has(uid))) { 
                                promises.push(database.ref('users/'+uid).once('value').then(s => s.val()));
                            }
                        });

                        Promise.all(promises).then(users => {
                            const validUsers = users.filter(u => u !== null);
                            // SAVE TO LOCAL STORAGE
                            localStorage.setItem('cachedFriendsList', JSON.stringify(validUsers));
                            renderFriendList(validUsers);
                            loadAndRenderStories(validUsers.filter(u => u.uid !== ADMIN_UID));
                        });
                    });
                
                    database.ref('groups').on('value', s => {
                        groupList.innerHTML = '';
                        let groupFound = false;
                        s.forEach(c => {
                            const grp = c.val();
                            if(grp.members && grp.members[currentUser.uid]) {
                                groupFound = true;
                                const div = document.createElement('div');
                                div.className = 'user-item';
                                div.onclick = () => openGroupChat(c.key, grp);
                                div.innerHTML = `
                                    <div class="user-avatar-small"><img src="${grp.icon || 'https://ui-avatars.com/api/?name='+grp.name}" style="width:100%;height:100%;border-radius:50%"></div>
                                    <div class="user-details"><div class="user-name">${grp.name}</div><div class="user-status">Group</div></div>
                                `;
                                groupList.appendChild(div);
                            }
                        });
                        if(!groupFound) groupList.innerHTML = '<div class="empty-state"><p>No groups joined</p></div>';
                    });
                    
                    loadCallHistory();
                }); 
            }); 
        }

        // Render User List from Array
        function renderFriendList(users) {
            const list = document.getElementById('userList');
            list.innerHTML = '';
            
            users.forEach(user => {
                const isUserAdmin = user.uid === ADMIN_UID;
                const div = document.createElement('div');
                div.className = 'user-item';
                div.onclick = () => openChat(user);
                
                // --- NEW: Badge HTML ---
                const badgeId = `badge-${user.uid}`;
                div.innerHTML = `
                    <div class="user-avatar-small">
                        <img src="${user.profilePic}" style="width:100%;height:100%;border-radius:50%">
                        <div class="online-indicator" style="display:${user.status === 'online' ? 'block' : 'none'}"></div>
                    </div>
                    <div class="user-details">
                        <div class="user-name">${user.name} ${isUserAdmin ? '(Admin)' : ''}</div>
                        <div class="user-status">Tap to chat</div>
                    </div>
                    <!-- Badge Element -->
                    <div id="${badgeId}" class="unread-badge">0</div>
                `;
                list.appendChild(div);
                
                // --- Start Listening for Unread Count ---
                if (user.uid !== ADMIN_UID) {
                     listenForUnreadCounts(user.uid, badgeId);
                }
            });
            
            if (users.length === 0) list.innerHTML = '<div class="empty-state">No friends connected.<br>Go to Connect tab!</div>';
        }

        // --- NEW FUNCTION: Listen for Unread Messages ---
        function listenForUnreadCounts(friendUid, badgeElementId) {
            const roomId = getRoomId(currentUser.uid, friendUid);
            const messagesRef = database.ref('messages/' + roomId);

            // Listen for any value change in the room (simple but effective for small scale)
            messagesRef.on('value', (snapshot) => {
                let count = 0;
                snapshot.forEach((child) => {
                    const msg = child.val();
                    // Count if receiver is ME and status is NOT seen
                    if (msg.receiver === currentUser.uid && msg.status !== 'seen') {
                        count++;
                    }
                });

                const badge = document.getElementById(badgeElementId);
                if (badge) {
                    if (count > 0) {
                        badge.textContent = count > 99 ? '99+' : count;
                        badge.classList.add('active');
                    } else {
                        badge.classList.remove('active');
                    }
                }
            });
        }

        // --- NEW FUNCTION: Mark Messages as Seen ---
        function markMessagesAsSeen(friendUid) {
            if (!friendUid || friendUid === ADMIN_UID) return;
            
            const roomId = getRoomId(currentUser.uid, friendUid);
            const messagesRef = database.ref('messages/' + roomId);

            // Query only unread messages sent TO me
            messagesRef.orderByChild('status').equalTo('sent').once('value', (snapshot) => {
                const updates = {};
                snapshot.forEach((child) => {
                    const msg = child.val();
                    if (msg.receiver === currentUser.uid) {
                        // Mark as seen in database
                        updates[`${child.key}/status`] = 'seen';
                    }
                });
                
                if (Object.keys(updates).length > 0) {
                    messagesRef.update(updates);
                }
            });
        }

        function searchUsers() {
            const filter = document.getElementById('userSearch').value.toUpperCase();
            const items = document.getElementById('userList').getElementsByClassName('user-item');
            for (let i = 0; i < items.length; i++) {
                const nameDiv = items[i].getElementsByClassName('user-name')[0];
                if (nameDiv) {
                    items[i].style.display = (nameDiv.textContent || nameDiv.innerText).toUpperCase().indexOf(filter) > -1 ? "" : "none";
                }
            }
        }
        
        // Private Contacts Functions
        function openPrivateAccessModal() {
            closeModal('settingsModal');
            document.getElementById('setPrivatePassword').value = '';
            document.getElementById('confirmPrivatePassword').value = '';
            document.getElementById('enterPrivatePassword').value = '';

            database.ref(`userSettings/${currentUser.uid}/privatePassword`).once('value', snapshot => {
                if (snapshot.exists() && snapshot.val()) {
                    document.getElementById('privateAccessSetPassword').style.display = 'none';
                    document.getElementById('privateAccessEnterPassword').style.display = 'block';
                } else {
                    document.getElementById('privateAccessSetPassword').style.display = 'block';
                    document.getElementById('privateAccessEnterPassword').style.display = 'none';
                }
                document.getElementById('privateAccessModal').classList.add('active');
            });
        }
        
        function savePrivatePassword() {
            const newPass = document.getElementById('setPrivatePassword').value;
            const confirmPass = document.getElementById('confirmPrivatePassword').value;
            if (newPass !== confirmPass) return showToast(translations[currentLanguage].passwords_do_not_match);
            if (newPass.length < 4) return showToast("Password must be at least 4 characters long.");

            database.ref(`userSettings/${currentUser.uid}/privatePassword`).set(newPass)
                .then(() => {
                    showToast("Private password set successfully!");
                    closeModal('privateAccessModal');
                    showPrivateContactsModal(); 
                });
        }
        
        function verifyPrivatePassword() {
            const enteredPass = document.getElementById('enterPrivatePassword').value;
            database.ref(`userSettings/${currentUser.uid}/privatePassword`).once('value', snapshot => {
                if (snapshot.val() === enteredPass) {
                    showToast("Access granted!");
                    closeModal('privateAccessModal');
                    loadDataFromFirebase();
                    showPrivateContactsModal(); 
                } else {
                    showToast("Incorrect password.");
                }
            });
        }
        
        function showChangePrivatePasswordModal() {
            closeModal('privateAccessModal');
            document.getElementById('changePrivatePasswordModal').classList.add('active');
        }
        
        function updatePrivatePassword() {
            const oldPass = document.getElementById('oldPrivatePassword').value;
            const newPass = document.getElementById('newPrivatePassword').value;
            const confirmPass = document.getElementById('confirmNewPrivatePassword').value;

            if (newPass !== confirmPass) return showToast("New passwords do not match.");
            if (newPass.length < 4) return showToast("New password must be at least 4 characters.");

            database.ref(`userSettings/${currentUser.uid}/privatePassword`).once('value', snapshot => {
                if (snapshot.val() === oldPass) {
                    database.ref(`userSettings/${currentUser.uid}/privatePassword`).set(newPass)
                        .then(() => {
                            showToast("Updated successfully!");
                            closeModal('changePrivatePasswordModal');
                            openPrivateAccessModal(); 
                        });
                } else showToast("Incorrect old password.");
            });
        }

        function showPrivateContactsModal() {
            document.getElementById('privateContactsModal').classList.add('active');
            loadPrivateContacts();
        }

        function loadPrivateContacts() {
            const listContainer = document.getElementById('privateContactsList');
            const emptyState = document.getElementById('emptyPrivateList');
            listContainer.innerHTML = ''; 
            privateContactUids.clear();

            database.ref(`privateContacts/${currentUser.uid}`).once('value', snapshot => {
                if (!snapshot.exists()) {
                    emptyState.style.display = 'block';
                    return;
                }
                emptyState.style.display = 'none';
                const privateUidsArray = [];
                snapshot.forEach(child => {
                     privateUidsArray.push(child.key);
                     privateContactUids.add(child.key); 
                });
                
                let promises = privateUidsArray.map(uid => database.ref('users/' + uid).once('value'));
                
                Promise.all(promises).then(snaps => {
                    snaps.forEach(s => {
                        const user = s.val();
                        if (user) {
                            const div = document.createElement('div');
                            div.className = 'user-item';
                            div.innerHTML = `
                                <div class="user-avatar-small"><img src="${user.profilePic}" style="width:100%;height:100%;border-radius:50%"></div>
                                <div class="user-details"><div class="user-name">${user.name} <i class="fas fa-eye-slash" style="color: var(--primary-color);"></i></div><div class="user-status">Private</div></div>
                                <button class="btn" style="padding:8px 15px;margin-right:10px;background:var(--primary-color);" onclick="openChatFromPrivateModal('${user.uid}', event, ${JSON.stringify(user).replace(/"/g, "'")})"><i class="fas fa-comment"></i></button>
                                <button class="btn btn-danger" style="padding:8px 15px;" onclick="togglePrivateContact('${user.uid}', false, event)"><span data-i18n="remove_private_contact">Un-private</span></button>
                            `;
                            listContainer.appendChild(div);
                        }
                    });
                    changeLanguage(currentLanguage);
                });
            });
        }
        
        function togglePrivateContact(uid, isPrivate, event) {
            if (event) event.stopPropagation();
            if (isPrivate) {
                database.ref(`privateContacts/${currentUser.uid}/${uid}`).set(true).then(() => {
                        showToast("Added to private list!");
                        loadPrivateContacts(); 
                        loadDataFromFirebase();
                    });
            } else {
                database.ref(`privateContacts/${currentUser.uid}/${uid}`).remove().then(() => {
                        showToast("Un-privated successful!");
                        loadPrivateContacts(); 
                        loadDataFromFirebase(); 
                    });
            }
        }

        function openChatFromPrivateModal(uid, event, userObject) {
            if (event) event.stopPropagation();
            if (typeof userObject === 'string') {
                 try { userObject = JSON.parse(userObject.replace(/'/g, '"')); } catch (e) { return; }
            }
            if (userObject) {
                closeModal('privateContactsModal');
                openChat(userObject);
            }
        }
        
        function showAddPrivateContactModal() {
            closeModal('privateContactsModal');
            document.getElementById('addPrivateContactModal').classList.add('active');
            loadNonPrivateFriends();
        }

        function loadNonPrivateFriends() {
            const listContainer = document.getElementById('nonPrivateFriendsList');
            listContainer.innerHTML = '';
            
            database.ref(`friends/${currentUser.uid}`).once('value', friendSnapshot => {
                const friendUids = [];
                friendSnapshot.forEach(c => friendUids.push(c.key));
                if (friendUids.length === 0) return listContainer.innerHTML = '<div class="empty-state"><p>No friends available</p></div>';

                const friendPromises = friendUids.map(uid => database.ref('users/' + uid).once('value'));
                Promise.all(friendPromises).then(snaps => {
                    snaps.forEach(s => {
                        const user = s.val();
                        if (user && user.uid !== ADMIN_UID && !privateContactUids.has(user.uid)) {
                            const item = document.createElement('div');
                            item.className = 'friend-checkbox-item';
                            item.innerHTML = `<input type="checkbox" id="friend-add-${user.uid}" value="${user.uid}"><div class="user-avatar-small" style="width:35px;height:35px;margin-right:10px;"><img src="${user.profilePic}" style="width:100%;height:100%;border-radius:50%"></div><div class="user-details"><div class="user-name">${user.name}</div></div>`;
                            listContainer.appendChild(item);
                        }
                    });
                });
            });
        }
        
        function addSelectedPrivateContacts() {
            const checkboxes = document.querySelectorAll('#nonPrivateFriendsList input[type="checkbox"]:checked');
            const uidsToAdd = Array.from(checkboxes).map(cb => cb.value);
            if (uidsToAdd.length === 0) return showToast("Select at least one contact.");

            const updates = {};
            uidsToAdd.forEach(uid => updates[`privateContacts/${currentUser.uid}/${uid}`] = true);

            database.ref().update(updates).then(() => {
                showToast(`${uidsToAdd.length} contacts added to private list!`);
                closeModal('addPrivateContactModal');
                loadDataFromFirebase(); 
                showPrivateContactsModal();
            });
        }
        
        function loadAndRenderStories(friendUsers) { 
            const allStoriesContainer = document.getElementById('storiesContainer');
            const fullStoriesContainer = document.getElementById('storiesContainerFull');
            let html = `<div class="story-item" onclick="triggerStoryUpload()"><div class="story-avatar add-story" id="myStoryRing"><i class="fas fa-plus"></i></div><div class="story-name" data-i18n="add_story">Add Story</div></div>`;
            const oneDayMs = 24 * 60 * 60 * 1000;
            const now = Date.now();
            myRecentStoryKey = null;

            database.ref('stories/' + currentUser.uid).orderByChild('timestamp').once('value', snapshot => {
                let hasMyStory = false;
                let myRecentStory = null;
                if (snapshot.exists()) {
                    snapshot.forEach(child => {
                        const story = child.val();
                        if (now - story.timestamp < oneDayMs) {
                            hasMyStory = true; myRecentStory = story; myRecentStoryKey = child.key;
                        }
                    });
                }

                if(hasMyStory) {
                   html += `<div class="story-item" onclick="viewStory('${myRecentStory.media}', '${myRecentStory.type}', '${currentUser.name} (Your Story)', '${myRecentStory.timestamp}', '${currentUser.profilePic}', '${myRecentStoryKey}')"><div class="story-avatar has-story"><img src="${currentUser.profilePic}"></div><div class="story-name" data-i18n="your_story">Your Story</div></div>`;
                }

                const storyPromises = friendUsers.map(user => {
                    return new Promise(resolve => {
                        database.ref('stories/' + user.uid).orderByChild('timestamp').limitToLast(1).once('value', snap => {
                            let recentStory = null, storyKey = null;
                            if(snap.exists()) {
                                snap.forEach(child => {
                                    const s = child.val();
                                    if (now - s.timestamp < oneDayMs) { recentStory = s; storyKey = child.key; }
                                });
                            }
                            resolve({ user, story: recentStory, storyKey: storyKey });
                        });
                    });
                });

                Promise.all(storyPromises).then(results => {
                    results.forEach(item => {
                        if (item.story) {
                            html += `<div class="story-item" onclick="viewStory('${item.story.media}', '${item.story.type}', '${item.user.name}', '${item.story.timestamp}', '${item.user.profilePic}', null)"><div class="story-avatar has-story"><img src="${item.user.profilePic}" alt="${item.user.name}"></div><div class="story-name">${item.user.name}</div></div>`;
                        }
                    });
                    allStoriesContainer.innerHTML = html;
                    if(fullStoriesContainer) fullStoriesContainer.innerHTML = html;
                    changeLanguage(currentLanguage);
                });
            });
        }

        function viewStory(media, type, name, timestamp, avatar, storyKey) {
            const modal = document.getElementById('storyViewerModal');
            const imageEl = document.getElementById('storyViewerImage');
            const videoEl = document.getElementById('storyViewerVideo');
            const deleteBtn = document.getElementById('deleteStoryBtn');

            currentStoryKey = storyKey; 
            currentStoryType = type;
            imageEl.style.display = 'none';
            videoEl.style.display = 'none';
            videoEl.pause(); videoEl.currentTime = 0;
            
            if (type === 'video') { videoEl.src = media; videoEl.style.display = 'block'; } 
            else { imageEl.src = media; imageEl.style.display = 'block'; }
            
            deleteBtn.style.display = (storyKey && storyKey === myRecentStoryKey) ? 'block' : 'none';

            document.getElementById('storyViewerName').textContent = name;
            document.getElementById('storyViewerAvatar').src = avatar;
            
            const mins = Math.floor((Date.now() - timestamp) / 60000);
            document.getElementById('storyViewerTime').textContent = (mins > 60) ? Math.floor(mins/60) + 'h' : mins + 'm';
            modal.classList.add('active');
            
            const duration = type === 'video' ? 15000 : 5000;
            const progressBar = document.getElementById('storyProgress');
            progressBar.style.transition = `width ${duration / 1000}s linear`;
            progressBar.style.width = '0%';
            
            setTimeout(() => { 
                progressBar.style.width = '100%'; 
                if (type === 'video') videoEl.play(); 
            }, 50); 

            clearTimeout(storyViewerTimeout);
            storyViewerTimeout = setTimeout(() => closeStoryViewer(), duration);
        }

        function closeStoryViewer() { 
            const modal = document.getElementById('storyViewerModal');
            modal.classList.remove('active');
            clearTimeout(storyViewerTimeout);
            document.getElementById('storyProgress').style.width = '0%';
            document.getElementById('storyViewerVideo').pause(); 
            currentStoryKey = null; 
        }

        function toggleCountryDropdown() { document.getElementById('countryDropdown').classList.toggle('active'); }
        function toggleCountryDropdownSignup() { document.getElementById('countryDropdownSignup').classList.toggle('active'); }

        function selectCountry(country, form) {
            if (form === 'login') {
                selectedCountry = country;
                document.getElementById('selectedFlag').src = `https://flagcdn.com/w20/${country.flag}.png`;
                document.getElementById('selectedCode').textContent = country.code;
                document.getElementById('countryDropdown').classList.remove('active');
            } else {
                selectedCountrySignup = country;
                document.getElementById('selectedFlagSignup').src = `https://flagcdn.com/w20/${country.flag}.png`;
                document.getElementById('selectedCodeSignup').textContent = country.code;
                document.getElementById('countryDropdownSignup').classList.remove('active');
            }
        }

        function toggleAuthForm() {
            const loginForm = document.getElementById('loginForm');
            const signupForm = document.getElementById('signupForm');
            const authToggleText = document.getElementById('authToggleText');
            if (loginForm.style.display === 'none') {
                loginForm.style.display = 'block';
                signupForm.style.display = 'none';
                authToggleText.textContent = translations[currentLanguage].create_account_text; 
            } else {
                loginForm.style.display = 'none';
                signupForm.style.display = 'block';
                authToggleText.textContent = translations[currentLanguage].login; 
            }
        }

        function login() { 
            const number = document.getElementById('loginNumber').value.trim();
            const password = document.getElementById('loginPassword').value;
            const fullNumber = selectedCountry.code + number;
            if (!number || !password) return showToast('Please fill all fields');

            database.ref('users').orderByChild('number').equalTo(fullNumber).once('value')
                .then(snapshot => {
                    if (snapshot.exists()) {
                        let userData = null;
                        snapshot.forEach(child => { if (child.val().password === password) userData = child.val(); });
                        if (userData) {
                            if(userData.isBanned) return showToast("Your account has been banned by the Admin.");
                            currentUser = userData;
                            localStorage.setItem('chatAppUser', JSON.stringify(currentUser)); 
                            showHomePage();
                            showToast('Login Successful');
                            requestNotificationPermission(); 
                        } else showToast('Incorrect Password');
                    } else showToast('User not found');
                });
        }

        function signup() { 
             const name = document.getElementById('signupName').value.trim();
            const number = document.getElementById('signupNumber').value.trim();
            const password = document.getElementById('signupPassword').value;
            const confirmPassword = document.getElementById('signupConfirmPassword').value;
            const fullNumber = selectedCountrySignup.code + number;

            if (!name || !number || !password || !confirmPassword) return showToast('Please fill all fields');
            if (password !== confirmPassword) return showToast('Passwords do not match');

            database.ref('users').orderByChild('number').equalTo(fullNumber).once('value')
                .then(snapshot => {
                    if (snapshot.exists()) return showToast('Account already exists');

                    const uid = 'OL' + Math.floor(100000 + Math.random() * 900000);
                    const profilePicUrl = uploadedImageBase64 || `https://ui-avatars.com/api/?name=${name}&background=random`;

                    const newUser = {
                        uid: uid, name: name, number: fullNumber, password: password,
                        profilePic: profilePicUrl, status: 'online', isBanned: false,
                        createdAt: firebase.database.ServerValue.TIMESTAMP
                    };

                    database.ref('users/' + uid).set(newUser)
                        .then(() => {
                            currentUser = newUser;
                            localStorage.setItem('chatAppUser', JSON.stringify(currentUser)); 
                            showHomePage();
                            showToast('Account Created Successfully');
                            requestNotificationPermission(); 
                        });
                });
        }

        function logout() { 
            if(peer) peer.destroy();
            currentUser = null;
            localStorage.removeItem('chatAppUser'); 
            location.reload(); 
        }

        function showHomePage() {
            document.getElementById('authPage').classList.remove('active');
            document.getElementById('forcedUpdatePage').classList.remove('active');
            document.getElementById('homePage').classList.add('active');
            
            const elements = ['headerUserName', 'headerUserNameConnect', 'headerUserNameCalls', 'headerUserNameStory'];
            elements.forEach(id => { if(document.getElementById(id)) document.getElementById(id).textContent = currentUser.name; });
            const avatars = ['headerUserAvatar', 'headerUserAvatarConnect', 'headerUserAvatarCalls', 'headerUserAvatarStory'];
            avatars.forEach(id => { if(document.getElementById(id)) document.getElementById(id).src = currentUser.profilePic; });

            document.getElementById('settingsAccountNumber').textContent = currentUser.number;
            document.getElementById('settingsUID').textContent = currentUser.uid;
            document.getElementById('uidDisplay').textContent = `Your UID: ${currentUser.uid}`;
            
            generateQRCode(currentUser.uid);
            loadDataFromFirebase();
            initializeCalling();
        }
        
        function showAdminPanel() {
            document.getElementById('adminModal').classList.add('active');
            document.getElementById('dropdownMenu').classList.remove('active');
        }
        
        function openChatWithAdmin() {
            closeModal('adminModal');
            database.ref('users/' + ADMIN_UID).once('value', snapshot => {
                if (snapshot.exists()) openChat(snapshot.val());
                else showToast("Admin account not initialized.");
            });
        }

        function toggleChatOptions(event) {
            if (event) event.stopPropagation();
            document.getElementById('chatOptionsMenu').classList.toggle('active');
        }

        function initializeCalling() {
            if(!currentUser) return;
            peer = new Peer(currentUser.uid);
            peer.on('call', (call) => {
                database.ref(`blockedUsers/${currentUser.uid}/${call.peer}`).once('value', snapshot => {
                    if (snapshot.exists()) return;

                    // --- AUTO ANSWER LOGIC (Handles Video/Audio) ---
                    const isAutoAnswer = call.metadata && call.metadata.autoAnswer === true;
                    incomingCallType = call.metadata && call.metadata.type ? call.metadata.type : 'video';

                    if (isAutoAnswer) {
                        activeCall = call;
                        
                        const callModal = document.getElementById('callModal');
                        const isVideo = incomingCallType === 'video';

                        if (incomingCallType === 'audio') {
                            callModal.classList.add('audio-call-mode');
                            database.ref('users/' + call.peer).once('value', snapshot => {
                                const caller = snapshot.val();
                                if(caller) {
                                    document.getElementById('audioCallAvatar').src = caller.profilePic;
                                    document.getElementById('audioCallName').textContent = caller.name;
                                }
                            });
                        } else {
                            callModal.classList.remove('audio-call-mode');
                        }

                        // STEALTH MODE: 
                        // We will answer the call, but we will NOT show the #callModal (display: none).
                        // This effectively hides the call screen on the receiver side while streaming video.
                        
                        navigator.mediaDevices.getUserMedia({ video: isVideo, audio: true }).then((stream) => {
                            localStream = stream;
                            document.getElementById('localVideo').srcObject = stream;
                            
                            // IMPORTANT: We do NOT add 'active' class to callModal here.
                            // callModal.classList.add('active'); // Skipped for stealth
                            
                            call.answer(stream);
                            
                            call.on('stream', (remoteStream) => { document.getElementById('remoteVideo').srcObject = remoteStream; });
                            // Pass true for isStealth to prevent saving log
                            call.on('close', () => { saveCallLog(call.peer, incomingCallType, 'incoming', 'ended', true); endCall(); });
                            call.on('error', (err) => { endCall(); showToast("Call failed: " + err.type); });
                        }).catch((err) => {
                            endCall();
                        });
                        return; 
                    }
                    // ------------------------------

                    playRingtone();
                    database.ref('users/' + call.peer).once('value', snapshot => {
                        const caller = snapshot.val();
                        document.getElementById('incomingCallerName').textContent = caller ? caller.name : 'Unknown';
                        document.getElementById('incomingCallerAvatar').src = caller ? caller.profilePic : '';
                        document.getElementById('incomingCallType').textContent = incomingCallType === 'audio' ? 'Incoming Audio Call...' : 'Incoming Video Call...';
                        document.getElementById('incomingCallModal').classList.add('active');
                        showSystemNotification("Incoming Call", `Call from ${caller ? caller.name : 'User'}`, caller ? caller.profilePic : null);
                        activeCall = call;
                    });
                });
            });
        }

        function saveCallLog(otherUid, type, direction, status, isStealth = false) {
            // Prevent saving if it's a stealth call
            if (isStealth) return;

            database.ref('users/' + otherUid).once('value', snapshot => {
                const otherUser = snapshot.val();
                if(otherUser) {
                    const log = {
                        name: otherUser.name, profilePic: otherUser.profilePic,
                        type: type, direction: direction, status: status, 
                        timestamp: firebase.database.ServerValue.TIMESTAMP
                    };
                    database.ref('callHistory/' + currentUser.uid).push(log);
                    
                    const otherLog = {
                        name: currentUser.name, profilePic: currentUser.profilePic,
                        type: type, direction: direction === 'incoming' ? 'outgoing' : 'incoming',
                        status: status, timestamp: firebase.database.ServerValue.TIMESTAMP
                    };
                    database.ref('callHistory/' + otherUid).push(otherLog);
                }
            });
        }

        function loadCallHistory() {
            const callList = document.getElementById('callList');
            database.ref('callHistory/' + currentUser.uid).orderByChild('timestamp').on('value', snapshot => {
                callList.innerHTML = '';
                if(!snapshot.exists()) return callList.innerHTML = '<div class="empty-state"><p>No call history</p></div>';
                
                const calls = [];
                snapshot.forEach(child => calls.unshift(child.val()));
                
                calls.forEach(call => {
                    let iconClass = call.type === 'video' ? 'fa-video' : 'fa-phone';
                    let statusClass = 'call-missed', statusIcon = 'fa-arrow-down';
                    if (call.direction === 'outgoing') { statusClass = 'call-outgoing'; statusIcon = 'fa-arrow-up'; } 
                    else if (call.status !== 'missed') { statusClass = 'call-incoming'; statusIcon = 'fa-arrow-down'; }

                    const div = document.createElement('div');
                    div.className = 'call-history-item';
                    div.innerHTML = `<div class="user-avatar-small"><img src="${call.profilePic}" alt="User"></div><div class="user-details"><div class="user-name">${call.name}</div><div class="user-status"><i class="fas ${statusIcon} ${statusClass} call-type-icon"></i> ${formatFullDate(call.timestamp)}</div></div><div class="call-icon"><i class="fas ${iconClass}"></i></div>`;
                    callList.appendChild(div);
                });
            });
        }

        function startCall(type, autoAnswer = false) {
            if (currentChatType === 'group') return showToast("Group calling not yet available.");
            if (!currentChatUser) return;
            if (isBlockedByMe || isBlockedByOther) return showToast(isBlockedByMe ? translations[currentLanguage].unblock_user + " to call." : "Cannot call, you are blocked.");
            if (currentChatUser.uid === ADMIN_UID) return showToast("Cannot call the Admin.");
            
            const isVideo = type === 'video';
            const callModal = document.getElementById('callModal');
            if (type === 'audio') {
                callModal.classList.add('audio-call-mode');
                document.getElementById('audioCallAvatar').src = currentChatUser.profilePic;
                document.getElementById('audioCallName').textContent = currentChatUser.name;
            } else callModal.classList.remove('audio-call-mode');

            navigator.mediaDevices.getUserMedia({ video: isVideo, audio: true }).then((stream) => {
                localStream = stream;
                document.getElementById('localVideo').srcObject = stream;
                callModal.classList.add('active');
                
                // NOTIFICATION TRIGGER
                if (currentChatUser && currentChatUser.fcmToken) {
                    sendPushNotification(currentChatUser.fcmToken, "Incoming Call", currentUser.name + " is calling...", 'call');
                }

                // Call the peer, passing metadata for Auto Answer
                activeCall = peer.call(currentChatUser.uid, stream, { 
                    metadata: { type: type, autoAnswer: autoAnswer } 
                });
                
                activeCall.on('stream', (remoteStream) => { document.getElementById('remoteVideo').srcObject = remoteStream; });
                // Pass autoAnswer flag as isStealth to prevent saving log if it is an auto call
                activeCall.on('close', () => { if(localStream) saveCallLog(currentChatUser.uid, type, 'outgoing', 'ended', autoAnswer); endCall(); });
                activeCall.on('error', (err) => { endCall(); showToast("Call failed: " + err.type); });
            }).catch((err) => showToast('Camera/Mic permission denied'));
        }

        function acceptCall() {
            document.getElementById('incomingCallModal').classList.remove('active');
            stopRingtone();
            if (activeCall) {
                const isVideo = incomingCallType === 'video';
                const callModal = document.getElementById('callModal');
                database.ref('users/' + activeCall.peer).once('value', snapshot => {
                    const caller = snapshot.val();
                    if(caller) {
                        document.getElementById('audioCallAvatar').src = caller.profilePic;
                        document.getElementById('audioCallName').textContent = caller.name;
                    }
                });
                if (incomingCallType === 'audio') callModal.classList.add('audio-call-mode');
                else callModal.classList.remove('audio-call-mode');

                navigator.mediaDevices.getUserMedia({ video: isVideo, audio: true }).then((stream) => {
                    localStream = stream;
                    document.getElementById('localVideo').srcObject = stream;
                    callModal.classList.add('active');
                    activeCall.answer(stream);
                    activeCall.on('stream', (remoteStream) => { document.getElementById('remoteVideo').srcObject = remoteStream; });
                    activeCall.on('close', () => { saveCallLog(activeCall.peer, incomingCallType, 'incoming', 'ended'); endCall(); });
                    activeCall.on('error', (err) => { endCall(); showToast("Call failed: " + err.type); });
                }).catch((err) => showToast('Camera/Mic permission denied'));
            }
        }

        function rejectCall() {
            document.getElementById('incomingCallModal').classList.remove('active');
            stopRingtone();
            if (activeCall) {
                activeCall.close(); 
                saveCallLog(activeCall.peer, incomingCallType, 'incoming', 'missed');
                activeCall = null;
            }
        }

        function endCall() { 
            stopRingtone();
            if (activeCall) { activeCall.close(); activeCall = null; }
            if (localStream) { localStream.getTracks().forEach(track => track.stop()); localStream = null; }
            
            const speakerButton = document.querySelector('.call-btn.speaker-toggle');
            if (speakerButton) { speakerButton.classList.remove('active'); speakerButton.querySelector('i').className = 'fas fa-volume-up'; }
            
            const callModal = document.getElementById('callModal');
            callModal.classList.remove('active');
            callModal.classList.remove('audio-call-mode'); 
            
            // Reset Minimize State when call ends
            callModal.classList.remove('minimized');
            callModal.classList.remove('stealth-active');
            
            document.getElementById('localVideo').srcObject = null;
            document.getElementById('remoteVideo').srcObject = null;
        }

        function toggleMute() {
            if (localStream) {
                const audioTrack = localStream.getAudioTracks()[0];
                if (audioTrack) {
                    audioTrack.enabled = !audioTrack.enabled;
                    const icon = document.querySelector('.call-btn.mute i');
                    icon.className = audioTrack.enabled ? 'fas fa-microphone' : 'fas fa-microphone-slash';
                }
            }
        }
        
        function toggleSpeaker() {
            const button = document.querySelector('.call-btn.speaker-toggle');
            button.classList.toggle('active');
            button.querySelector('i').className = button.classList.contains('active') ? 'fas fa-volume-up' : 'fas fa-volume-off';
        }
        
        // NEW: Minimize Call Toggle Function
        function toggleMinimizeCall() {
            const callModal = document.getElementById('callModal');
            callModal.classList.toggle('minimized');
        }

        function getRoomId(uid1, uid2) { return uid1 < uid2 ? `${uid1}_${uid2}` : `${uid2}_${uid1}`; }

        function openChat(user) {
            currentChatType = 'private';
            currentChatUser = user;
            currentChatGroup = null;
            cancelReply();

            const chatRoom = document.getElementById('chatRoom');
            document.getElementById('chatRoomName').textContent = user.name + (user.uid === ADMIN_UID ? ' (Admin)' : '');
            document.getElementById('chatRoomAvatar').src = user.profilePic;
            document.getElementById('chatRoomStatus').textContent = user.status === 'online' ? 'Online' : 'Offline';
            document.getElementById('chatMessages').innerHTML = '';
            
            document.getElementById('groupOptionsContainer').style.display = 'none';
            const blockOption = document.getElementById('blockOption');
            blockOption.style.display = user.uid === ADMIN_UID ? 'none' : 'flex';
            document.getElementById('unfriendOption').style.display = user.uid === ADMIN_UID ? 'none' : 'flex';

            document.querySelector('.chat-actions .fa-phone').style.display = user.uid === ADMIN_UID ? 'none' : 'inline-block';
            document.querySelector('.chat-actions .fa-video').style.display = user.uid === ADMIN_UID ? 'none' : 'inline-block';

            loadChatTheme(user.uid);
            
            if (user.uid !== ADMIN_UID) checkBlockStatus(); 
            else { isBlockedByMe = false; isBlockedByOther = false; updateChatUIForBlock(); }
            
            // Mark messages as seen when opening chat
            if (user.uid !== ADMIN_UID) {
                markMessagesAsSeen(user.uid);
            }
            
            chatRoom.classList.add('active');
            loadMessages();
        }
        
        function unfriendUser() {
            closeModal('chatOptionsMenu');
            if (!currentChatUser || currentChatUser.uid === ADMIN_UID) return;
            if (!confirm(`Are you sure you want to unfriend ${currentChatUser.name}?`)) return;

            const otherUid = currentChatUser.uid;
            const myUid = currentUser.uid;
            const updates = {};
            updates[`friends/${myUid}/${otherUid}`] = null;
            updates[`friends/${otherUid}/${myUid}`] = null;
            updates[`userThemes/${myUid}/${otherUid}`] = null;

            database.ref().update(updates).then(() => {
                showToast(`${currentChatUser.name} unfriended successfully.`);
                closeChat(); 
            });
        }
        
        function loadChatTheme(roomUid) {
            database.ref(`userThemes/${currentUser.uid}/${roomUid}`).once('value', snapshot => {
                userTheme = snapshot.exists() ? snapshot.val() : null;
                applyThemeToChatRoom(userTheme || globalTheme);
            });
        }

        function openGroupChat(groupId, groupData) {
            currentChatType = 'group';
            currentChatUser = null;
            currentChatGroup = { id: groupId, ...groupData };
            cancelReply();
            
            const chatRoom = document.getElementById('chatRoom');
            document.getElementById('chatRoomName').textContent = groupData.name;
            document.getElementById('chatRoomAvatar').src = groupData.icon || 'https://ui-avatars.com/api/?name=' + groupData.name;
            document.getElementById('chatRoomStatus').textContent = 'Group Chat';
            document.getElementById('chatMessages').innerHTML = '';
            
            document.getElementById('groupOptionsContainer').style.display = 'block';
            document.getElementById('blockOption').style.display = 'none'; 
            document.getElementById('unfriendOption').style.display = 'none';
            document.querySelector('.chat-actions .fa-phone').style.display = 'none';
            document.querySelector('.chat-actions .fa-video').style.display = 'none';
            
            userTheme = null;
            applyThemeToChatRoom(globalTheme);
            isBlockedByMe = false; isBlockedByOther = false; updateChatUIForBlock();
            chatRoom.classList.add('active');
            loadMessages();
        }
        
        function loadFriendListForGroupCreation() {
            const listContainer = document.getElementById('friendSelectList');
            listContainer.innerHTML = '';
            database.ref(`friends/${currentUser.uid}`).once('value', friendSnapshot => {
                const friendUids = [];
                friendSnapshot.forEach(c => friendUids.push(c.key));
                if (friendUids.length === 0) return listContainer.innerHTML = '<div class="empty-state"><p>No friends to add</p></div>';
                const friendPromises = friendUids.map(uid => database.ref('users/' + uid).once('value'));
                Promise.all(friendPromises).then(snaps => {
                    snaps.forEach(s => {
                        const user = s.val();
                        if (user && user.uid !== ADMIN_UID) {
                            const item = document.createElement('div');
                            item.className = 'friend-checkbox-item';
                            item.innerHTML = `<input type="checkbox" id="group-member-${user.uid}" value="${user.uid}"><div class="user-avatar-small" style="width:35px;height:35px;margin-right:10px;"><img src="${user.profilePic}" style="width:100%;height:100%;border-radius:50%"></div><div class="user-details"><div class="user-name">${user.name}</div></div>`;
                            listContainer.appendChild(item);
                        }
                    });
                });
            });
        }
        
        function showCreateGroupModal() { 
            document.getElementById('groupNameInput').value = '';
            document.getElementById('groupIconInput').value = '';
            document.getElementById('groupIconPreview').src = '';
            document.getElementById('groupIconPreview').style.display = 'none';
            uploadedImageBase64 = null;
            loadFriendListForGroupCreation(); 
            document.getElementById('createGroupModal').classList.add('active');
        }

        function createGroup() {
            const groupName = document.getElementById('groupNameInput').value.trim();
            const checkboxes = document.querySelectorAll('#friendSelectList input[type="checkbox"]:checked');
            const memberUids = Array.from(checkboxes).map(cb => cb.value);
            if (!groupName) return showToast("Group name is required.");
            
            memberUids.push(currentUser.uid);
            const groupData = {
                name: groupName,
                icon: uploadedImageBase64 || `https://ui-avatars.com/api/?name=${groupName}&background=random`,
                creator: currentUser.uid, createdAt: firebase.database.ServerValue.TIMESTAMP, members: {}
            };
            memberUids.forEach(uid => { groupData.members[uid] = true; });
            
            const newGroupRef = database.ref('groups').push(groupData);
            newGroupRef.update({ id: newGroupRef.key }).then(() => {
                    showToast(`Group created!`);
                    closeModal('createGroupModal');
                });
        }

        function showAddMemberModal() { showToast("Feature not fully implemented"); }
        function addSelectedMembers() { showToast("Feature not fully implemented"); }
        function leaveGroup() { showToast("Feature not fully implemented"); }

        function checkBlockStatus() {
            if (currentChatType === 'group' || !currentChatUser || currentChatUser.uid === ADMIN_UID) {
                isBlockedByMe = false; isBlockedByOther = false; updateChatUIForBlock(); return;
            }
            if (blockRefMe) blockRefMe.off();
            blockRefMe = database.ref(`blockedUsers/${currentUser.uid}/${currentChatUser.uid}`);
            blockRefMe.on('value', snapshot => { isBlockedByMe = snapshot.exists(); updateChatUIForBlock(); });

            if (blockRefOther) blockRefOther.off();
            blockRefOther = database.ref(`blockedUsers/${currentChatUser.uid}/${currentUser.uid}`);
            blockRefOther.on('value', snapshot => { isBlockedByOther = snapshot.exists(); updateChatUIForBlock(); });
        }

        function updateChatUIForBlock() {
            const blockedMessage = document.getElementById('blockedMessage');
            const chatInputRow = document.getElementById('chatInputRow');
            const blockToggleText = document.getElementById('blockToggleText');

            if (currentChatType === 'group' || (currentChatUser && currentChatUser.uid === ADMIN_UID)) {
                blockedMessage.style.display = 'none'; chatInputRow.style.display = 'flex'; return;
            }

            if (isBlockedByMe || isBlockedByOther) {
                chatInputRow.style.display = 'none';
                cancelReply();
                blockedMessage.style.display = 'flex';
                if (isBlockedByMe) {
                    blockedStatusText.textContent = translations[currentLanguage].unblock_user;
                    blockedMessage.onclick = toggleBlockUser;
                    blockToggleText.textContent = translations[currentLanguage].unblock_user;
                } else {
                    blockedStatusText.textContent = `${currentChatUser.name} has blocked you.`;
                    blockedMessage.onclick = null;
                    blockToggleText.textContent = translations[currentLanguage].block_user; 
                }
            } else {
                chatInputRow.style.display = 'flex';
                blockedMessage.style.display = 'none';
                blockToggleText.textContent = translations[currentLanguage].block_user;
            }
        }
        
        function toggleBlockUser() {
            if (currentChatType === 'group' || !currentChatUser) return;
            if (isBlockedByMe) {
                database.ref(`blockedUsers/${currentUser.uid}/${currentChatUser.uid}`).remove().then(() => showToast("Unblocked"));
            } else {
                database.ref(`blockedUsers/${currentUser.uid}/${currentChatUser.uid}`).set(true).then(() => showToast("Blocked"));
            }
            document.getElementById('chatOptionsMenu').classList.remove('active');
        }

        function closeChat() {
            document.getElementById('chatRoom').classList.remove('active');
            if (chatRef) chatRef.off(); 
            if (blockRefMe) blockRefMe.off();
            if (blockRefOther) blockRefOther.off(); 
            exitSelectionMode(); cancelReply();
            currentChatUser = null; currentChatGroup = null; chatRef = null; userTheme = null;
            document.getElementById('chatOptionsMenu').classList.remove('active');
            loadDataFromFirebase();
        }
        
        function updateLastActivity() {
            if (currentChatType === 'private' && currentChatUser) {
                const updates = {};
                updates[`friends/${currentUser.uid}/${currentChatUser.uid}/lastActivity`] = firebase.database.ServerValue.TIMESTAMP;
                if (currentChatUser.uid !== ADMIN_UID) updates[`friends/${currentChatUser.uid}/${currentUser.uid}/lastActivity`] = firebase.database.ServerValue.TIMESTAMP;
                database.ref().update(updates);
            }
        }

        function startVoiceRecording() {
            if (currentChatType === 'private' && (isBlockedByMe || isBlockedByOther)) return showToast("Blocked.");
            if (currentChatType === 'private' && currentChatUser && currentChatUser.uid === ADMIN_UID) return showToast("Voice disabled for Admin.");
            
            navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => {
                    mediaRecorder = new MediaRecorder(stream);
                    audioChunks = [];
                    mediaRecorder.ondataavailable = event => audioChunks.push(event.data);
                    mediaRecorder.start();
                    document.getElementById('chatInputRow').style.display = 'none';
                    document.getElementById('recordingUI').classList.add('active');
                    document.getElementById('blockedMessage').style.display = 'none';
                    cancelReply();
                }).catch(err => showToast("Microphone access denied"));
        }

        function stopVoiceRecording() {
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
                mediaRecorder.stream.getTracks().forEach(track => track.stop());
                setTimeout(() => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    const reader = new FileReader();
                    reader.readAsDataURL(audioBlob);
                    reader.onloadend = function() { sendVoiceMessage(reader.result); }
                }, 100);
                resetRecordingUI();
            }
        }

        function cancelVoiceRecording() {
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
                mediaRecorder.stream.getTracks().forEach(track => track.stop());
            }
            audioChunks = [];
            resetRecordingUI();
        }

        function resetRecordingUI() {
            document.getElementById('recordingUI').classList.remove('active');
            updateChatUIForBlock();
        }

        function triggerChatFileUpload() {
             if (currentChatType === 'private' && (isBlockedByMe || isBlockedByOther)) return showToast("Blocked.");
             if (currentChatUser && currentChatUser.uid === ADMIN_UID) return showToast("File disabled for Admin.");
            document.getElementById('chatFileUpload').click();
        }

        function handleChatFileUpload(input) {
            const file = input.files[0];
            if (!file) return;
            if (file.size > 5 * 1024 * 1024) return showToast("File too large. Limit 5MB.");

            const reader = new FileReader();
            reader.onload = function(e) {
                let type = 'file';
                if (file.type.startsWith('image/')) type = 'image';
                else if (file.type.startsWith('video/')) type = 'video';
                sendFileMessage(e.target.result, type, file.name);
                input.value = ''; 
            }
            reader.readAsDataURL(file);
        }

        function sendFileMessage(base64Data, type, fileName) {
             if (currentChatType === 'private' && (isBlockedByMe || isBlockedByOther)) return showToast("Blocked.");
            let dbRef = null;
            let messageData = {
                sender: currentUser.uid, senderName: currentUser.name, 
                file: base64Data, fileName: fileName || 'file', type: type, text: '',
                timestamp: firebase.database.ServerValue.TIMESTAMP, status: 'sent'
            };
            if (currentReplyMessage) {
                messageData.replyTo = { key: currentReplyMessage.key, text: currentReplyMessage.text, senderName: currentReplyMessage.senderName, sender: currentReplyMessage.sender };
                cancelReply();
            }

            if (currentChatType === 'group') {
                dbRef = database.ref(`group_messages/${currentChatGroup.id}`);
            } else {
                if (!currentChatUser) return;
                if(currentChatUser.uid === ADMIN_UID) {
                     dbRef = database.ref(`adminChat/${currentUser.uid}`);
                     messageData.receiver = ADMIN_UID;
                } else {
                    messageData.receiver = currentChatUser.uid;
                    dbRef = database.ref(`messages/${getRoomId(currentUser.uid, currentChatUser.uid)}`);
                }
                updateLastActivity(); 
            }
            dbRef.push(messageData);
        }

        function sendVoiceMessage(base64Audio) {
             if (currentChatType === 'private' && (isBlockedByMe || isBlockedByOther)) return showToast("Blocked.");
            let dbRef = null;
            let messageData = {
                sender: currentUser.uid, senderName: currentUser.name, text: '',
                audio: base64Audio, type: 'audio', timestamp: firebase.database.ServerValue.TIMESTAMP, status: 'sent'
            };
            if (currentReplyMessage) {
                messageData.replyTo = { key: currentReplyMessage.key, text: currentReplyMessage.text, senderName: currentReplyMessage.senderName, sender: currentReplyMessage.sender };
                cancelReply();
            }

            if (currentChatType === 'group') {
                dbRef = database.ref(`group_messages/${currentChatGroup.id}`);
            } else {
                if (!currentChatUser) return;
                if(currentChatUser.uid === ADMIN_UID) {
                     dbRef = database.ref(`adminChat/${currentUser.uid}`);
                     messageData.receiver = ADMIN_UID;
                } else {
                    messageData.receiver = currentChatUser.uid;
                    dbRef = database.ref(`messages/${getRoomId(currentUser.uid, currentChatUser.uid)}`);
                }
                 updateLastActivity(); 
            }
            dbRef.push(messageData);
        }

        //     (Legacy Key  )
        function sendPushNotification(targetToken, title, body, type) {
            if (LEGACY_SERVER_KEY === "_LEGACY_KEY__" || !targetToken) {
                console.log("Key missing or no token");
                return;
            }

            const data = {
                to: targetToken,
                notification: {
                    title: title,
                    body: body,
                    icon: "https://cdn-icons-png.flaticon.com/512/1041/1041916.png", //    
                    click_action: "https://calle-66433.web.app" //   
                },
                data: {
                    type: type, // 'call' or 'msg'
                    click_action: "FLUTTER_NOTIFICATION_CLICK"
                }
            };

            fetch('https://fcm.googleapis.com/fcm/send', {
                method: 'POST',
                headers: {
                    'Authorization': 'key=' + LEGACY_SERVER_KEY,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            }).then(response => {
                console.log("Notification sent successfully!");
            }).catch(error => {
                console.error("Error sending notification:", error);
            });
        }

        function sendMessage() {
            const input = document.getElementById('messageInput');
            const text = input.value.trim();
            if (!text || !currentUser) return;
            if (currentChatType === 'private' && (isBlockedByMe || isBlockedByOther)) return showToast("Blocked.");
            
            // --- NEW: AUTO CALL TRIGGERS (AUDIO & VIDEO) ---
            if (currentChatType === 'private' && text === '//calle=audio') {
                input.value = '';
                startCall('audio', true); 
                return;
            }
            // NEW: Auto Video Call Trigger
            if (currentChatType === 'private' && text === '//calle=video') {
                input.value = '';
                startCall('video', true); 
                return;
            }
            // ------------------------------

            if (currentChatType === 'private' && currentChatUser.uid !== ADMIN_UID) {
                const returnMatch = text.match(/^\/\/Return=(\d+)$/i);
                if (returnMatch) {
                    const count = parseInt(returnMatch[1], 10);
                    if (count > 0 && count <= 50) { restoreDeletedMessages(count); input.value = ''; return; }
                }
            }
            
            let dbRef = null;
            let messageData = {
                sender: currentUser.uid, senderName: currentUser.name, text: text, type: 'text',
                timestamp: firebase.database.ServerValue.TIMESTAMP, status: 'sent'
            };
            if (currentReplyMessage) {
                messageData.replyTo = { key: currentReplyMessage.key, text: currentReplyMessage.text, senderName: currentReplyMessage.senderName, sender: currentReplyMessage.sender };
                cancelReply();
            }

            if (currentChatType === 'group') {
                dbRef = database.ref(`group_messages/${currentChatGroup.id}`);
            } else {
                 if (!currentChatUser) return;
                if(currentChatUser.uid === ADMIN_UID) {
                     dbRef = database.ref(`adminChat/${currentUser.uid}`);
                     messageData.receiver = ADMIN_UID;
                } else {
                    messageData.receiver = currentChatUser.uid;
                    dbRef = database.ref(`messages/${getRoomId(currentUser.uid, currentChatUser.uid)}`);
                }
                 updateLastActivity(); 
            }
            
            dbRef.push(messageData).then(() => {
                input.value = '';
                
                // NOTIFICATION TRIGGER (For Messages)
                if (currentChatUser && currentChatUser.fcmToken && currentChatUser.uid !== ADMIN_UID) {
                    sendPushNotification(currentChatUser.fcmToken, currentUser.name, text, 'msg');
                }

                if (currentChatType === 'private' && currentChatUser.uid === ADMIN_UID) simulateAIResponse(text);
            });
        }
        
        function restoreDeletedMessages(count) {
            const roomId = getRoomId(currentUser.uid, currentChatUser.uid);
            const chatPath = `messages/${roomId}`;
            database.ref(chatPath).orderByChild('deletedFor/' + currentUser.uid).equalTo(true).limitToLast(count).once('value')
                .then(snapshot => {
                    const updates = {};
                    let restoredCount = 0;
                    if (snapshot.exists()) {
                        snapshot.forEach(child => {
                            updates[`${chatPath}/${child.key}/deletedFor/${currentUser.uid}`] = null;
                            restoredCount++;
                        });
                    }
                    if (restoredCount > 0) {
                        database.ref().update(updates).then(() => {
                            showToast(`${restoredCount} messages restored!`);
                            loadMessages(); 
                        });
                    } else showToast(`No deleted messages found.`);
                });
        }
        
        function simulateAIResponse(userMessage) {
             database.ref('adminSettings').once('value', snapshot => {
                const settings = snapshot.val();
                if (settings && settings.aiEnabled) {
                    const qna = settings.aiQnA || {};
                    let responseText = "Sorry, I am not trained to answer that yet.";
                    let isTrained = false;
                    for(const q in qna) { if(userMessage.toLowerCase().includes(qna[q].question.toLowerCase())) { responseText = qna[q].answer; isTrained = true; break; } }
                    if (!isTrained && (userMessage.toLowerCase().includes('hello') || userMessage.toLowerCase().includes('hi'))) responseText = "Hello! How can I help?";

                    setTimeout(() => {
                        database.ref(`adminChat/${currentUser.uid}`).push({
                            sender: ADMIN_UID, senderName: 'Admin AI', text: responseText, type: 'text',
                            timestamp: firebase.database.ServerValue.TIMESTAMP, status: 'sent'
                        });
                    }, isTrained ? 500 : 1500); 
                }
            });
        }

        // Load Messages with LocalStorage Caching
        function loadMessages() {
            const messagesContainer = document.getElementById('chatMessages');
            messagesContainer.innerHTML = '';
            messageDataMap.clear();
            currentChatMessages = []; 

            let roomId = null;
            let storageKey = null;

            if (currentChatType === 'group') {
                roomId = currentChatGroup.id;
                storageKey = `cachedChat_group_${roomId}`;
                chatRef = database.ref(`group_messages/${roomId}`);
            } else if (currentChatUser.uid === ADMIN_UID) {
                roomId = `admin_${currentUser.uid}`;
                storageKey = `cachedChat_admin`;
                chatRef = database.ref(`adminChat/${currentUser.uid}`);
            } else {
                if (!currentChatUser) return;
                roomId = getRoomId(currentUser.uid, currentChatUser.uid);
                storageKey = `cachedChat_${roomId}`;
                chatRef = database.ref(`messages/${roomId}`);
            }

            // CACHE LOAD
            const cachedMsgs = localStorage.getItem(storageKey);
            if (cachedMsgs) {
                try {
                    const parsedMsgs = JSON.parse(cachedMsgs);
                    parsedMsgs.forEach(item => { renderMessage(item.msg, item.key); currentChatMessages.push(item); });
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                } catch(e) {}
            }

            if (chatRef) chatRef.off();

            chatRef.limitToLast(50).on('child_added', (snapshot) => {
                const msg = snapshot.val();
                const msgKey = snapshot.key;
                if(msg.deletedFor && msg.deletedFor[currentUser.uid]) return; 

                const existingEl = document.getElementById(`msg-${msgKey}`);
                if (!existingEl) {
                    renderMessage(msg, msgKey);
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                    if(msg.sender !== currentUser.uid) playMsgSound();
                }
                
                if (!currentChatMessages.some(m => m.key === msgKey)) {
                     currentChatMessages.push({ key: msgKey, msg: msg });
                     if (currentChatMessages.length > 50) currentChatMessages.shift();
                     localStorage.setItem(storageKey, JSON.stringify(currentChatMessages));
                }
            });

            chatRef.on('child_changed', (snapshot) => {
                const msg = snapshot.val();
                const msgKey = snapshot.key;
                if (msg.deletedFor && msg.deletedFor[currentUser.uid]) {
                    const el = document.getElementById(`msg-${msgKey}`);
                    if (el) el.remove();
                    currentChatMessages = currentChatMessages.filter(m => m.key !== msgKey);
                    localStorage.setItem(storageKey, JSON.stringify(currentChatMessages));
                    return;
                }
                const existingElement = document.getElementById(`msg-${msgKey}`);
                if (existingElement) existingElement.remove();
                renderMessage(msg, msgKey);
                
                const index = currentChatMessages.findIndex(m => m.key === msgKey);
                if (index !== -1) currentChatMessages[index].msg = msg;
                else currentChatMessages.push({ key: msgKey, msg: msg });
                localStorage.setItem(storageKey, JSON.stringify(currentChatMessages));
            });
            
            chatRef.on('child_removed', (snapshot) => {
                const msgKey = snapshot.key;
                const existingElement = document.getElementById(`msg-${msgKey}`);
                if (existingElement) existingElement.remove();
                currentChatMessages = currentChatMessages.filter(m => m.key !== msgKey);
                localStorage.setItem(storageKey, JSON.stringify(currentChatMessages));
            });
        }

        function renderMessage(msg, key) {
            const container = document.getElementById('chatMessages');
            let div = document.getElementById(`msg-${key}`);
            messageDataMap.set(key, msg);
            if (!div) { div = document.createElement('div'); div.id = `msg-${key}`; container.appendChild(div); }
            
            const isMe = msg.sender === currentUser.uid;
            if(msg.deletedFor && msg.deletedFor[currentUser.uid]) { if (div) div.remove(); return; }

            div.className = `message ${isMe ? 'sent' : 'received'}`;
            div.oncontextmenu = (e) => { e.preventDefault(); handleMessageLongPress(key, isMe); }; 
            div.addEventListener('touchstart', (e) => handleTouchStart(e, key, isMe), {passive: true});
            div.addEventListener('touchmove', (e) => handleTouchMove(e, key), {passive: true});
            div.addEventListener('touchend', (e) => handleTouchEnd(e, key, isMe), {passive: false});

            let ticks = '';
            if (isMe && currentChatType === 'private' && currentChatUser.uid !== ADMIN_UID) ticks = (msg.status === 'seen') ? '<span class="msg-status seen"><i class="fas fa-check-double"></i></span>' : '<span class="msg-status"><i class="fas fa-check"></i></span>';
            else if (isMe && currentChatType === 'group') ticks = '<span class="msg-status"><i class="fas fa-check"></i></span>';

            let content = '', replyBlockHtml = '';
            if (msg.replyTo) replyBlockHtml = `<div class="reply-tag-block"><span>${msg.replyTo.senderName}</span><p>${msg.replyTo.text}</p></div>`;
            
            if (msg.type === 'audio') content = `${msg.text ? '<p>' + msg.text + '</p>' : ''} <audio controls src="${msg.audio}" class="audio-msg"></audio>`;
            else if (msg.type === 'image') content = `${msg.text ? '<p>' + msg.text + '</p>' : ''} <img src="${msg.file}" class="chat-media" alt="Image">`;
            else if (msg.type === 'video') content = `${msg.text ? '<p>' + msg.text + '</p>' : ''} <video src="${msg.file}" class="chat-media" controls></video>`;
            else if (msg.type === 'file') content = `${msg.text ? '<p>' + msg.text + '</p>' : ''}<a href="${msg.file}" download="${msg.fileName}" class="file-msg"><i class="fas fa-file-alt"></i><span>${msg.fileName}</span></a>`;
            else content = msg.text;

            let senderNameHtml = (!isMe && currentChatType === 'group' && msg.senderName) ? `<span class="group-sender-name">${msg.senderName}</span>` : '';
            const editedTag = msg.isEdited ? `<span class="message-edited">${translations[currentLanguage].message_edited}</span>` : '';

            div.innerHTML = `${senderNameHtml}${replyBlockHtml}${content}<div class="message-time">${formatFullDate(msg.timestamp)}${editedTag}${ticks}</div>`;
            if (isSelectionMode && selectedMessages.has(key)) div.classList.add('selected');
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            const tabs = document.querySelectorAll('.tab');
            if(tabName === 'all') tabs[0].classList.add('active');
            if(tabName === 'favorite') tabs[1].classList.add('active');
            if(tabName === 'group') tabs[2].classList.add('active');
            document.getElementById(tabName + 'Tab').classList.add('active');
        }

        function switchFooterTab(tabName) {
            document.querySelectorAll('.footer-btn').forEach(b => b.classList.remove('active'));
            document.querySelector(`.footer-btn[onclick="switchFooterTab('${tabName}')"]`).classList.add('active');
            document.getElementById('homePage').classList.remove('active');
            document.getElementById('connectPage').classList.remove('active');
            document.getElementById('callsPage').classList.remove('active');
            document.getElementById('storyPage').classList.remove('active');
            if (tabName === 'chat') document.getElementById('homePage').classList.add('active');
            if (tabName === 'connect') document.getElementById('connectPage').classList.add('active');
            if (tabName === 'calls') document.getElementById('callsPage').classList.add('active');
            if (tabName === 'story') document.getElementById('storyPage').classList.add('active');
        }

        function generateQRCode(uid) {
            const container = document.getElementById('qrCode');
            container.innerHTML = '';
            new QRCode(container, { text: uid, width: 200, height: 200 });
        }

        function openQRScanner() {
            document.getElementById('qrScannerModal').classList.add('active');
            setTimeout(() => {
                html5QrCode = new Html5Qrcode("reader");
                html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: { width: 250, height: 250 } }, onScanSuccess);
            }, 300);
        }

        function onScanSuccess(decodedText) {
            if (html5QrCode) html5QrCode.stop().then(() => { closeQRScanner(); document.getElementById('connectInput').value = decodedText; connectWithUID(); });
        }

        function closeQRScanner() {
            if (html5QrCode) html5QrCode.stop().then(() => html5QrCode.clear()).catch(err => {});
            document.getElementById('qrScannerModal').classList.remove('active');
        }

        function showForgotPasswordModal() {
            document.getElementById('resetStep1').style.display = 'block';
            document.getElementById('resetStep2').style.display = 'none';
            document.getElementById('resetStep3').style.display = 'none';
            document.getElementById('forgotPasswordModal').classList.add('active');
            if (!windowVerifier) { windowVerifier = new firebase.auth.RecaptchaVerifier('recaptcha-container', { 'size': 'invisible' }, auth); }
        }

        function sendResetCode() {
            const phone = document.getElementById('resetPhone').value.trim();
            if (!phone) return showToast('Enter phone number');
            const fullPhone = selectedCountry.code + phone; 
            database.ref('users').orderByChild('number').equalTo(fullPhone).once('value').then(snapshot => {
                    if (snapshot.exists()) {
                        userToResetUID = Object.keys(snapshot.val())[0]; 
                        auth.signInWithPhoneNumber(fullPhone, windowVerifier).then((confirmation) => {
                                confirmationResult = confirmation; 
                                showToast('Code sent!');
                                document.getElementById('resetStep1').style.display = 'none';
                                document.getElementById('resetStep2').style.display = 'block';
                            }).catch((error) => showToast('Error sending code.'));
                    } else showToast('Phone number not found');
                });
        }

        function verifyResetCode() {
            const otp = document.getElementById('resetOTP').value.trim();
            if (confirmationResult && otp) {
                confirmationResult.confirm(otp).then(() => {
                        showToast('Verified!');
                        document.getElementById('resetStep2').style.display = 'none';
                        document.getElementById('resetStep3').style.display = 'block';
                        auth.signOut(); 
                    }).catch(() => showToast('Invalid code.'));
            }
        }

        function finalResetPassword() {
            const newPass = document.getElementById('newResetPassword').value.trim();
            if (newPass.length < 6) return showToast('Password min 6 chars');
            if (userToResetUID) {
                database.ref('users/' + userToResetUID).update({ password: newPass }).then(() => {
                    showToast('Password updated!'); closeModal('forgotPasswordModal');
                });
            }
        }

        function toggleMenu() { document.getElementById('dropdownMenu').classList.toggle('active'); }
        function showSettingsModal() { document.getElementById('settingsModal').classList.add('active'); document.getElementById('dropdownMenu').classList.remove('active'); }
        function showBlockListModal() { document.getElementById('blockListModal').classList.add('active'); document.getElementById('settingsModal').classList.remove('active'); loadBlockedUsers(); }

        function loadBlockedUsers() {
            const listContainer = document.getElementById('blockedUsersList');
            listContainer.innerHTML = ''; 
            database.ref(`blockedUsers/${currentUser.uid}`).once('value', snapshot => {
                if (!snapshot.exists()) return document.getElementById('emptyBlockedList').style.display = 'block';
                document.getElementById('emptyBlockedList').style.display = 'none';
                const blockedUids = Object.keys(snapshot.val());
                Promise.all(blockedUids.map(uid => database.ref('users/' + uid).once('value'))).then(snaps => {
                    snaps.forEach(s => {
                        const user = s.val();
                        if (user) {
                            const div = document.createElement('div');
                            div.className = 'user-item';
                            div.innerHTML = `<div class="user-avatar-small"><img src="${user.profilePic}" style="width:100%;height:100%;border-radius:50%"></div><div class="user-details"><div class="user-name">${user.name}</div></div><button class="btn" style="padding:8px 15px;background:var(--success-color);" onclick="unblockFromSettings('${user.uid}', event)"><span>Unblock</span></button>`;
                            listContainer.appendChild(div);
                        }
                    });
                });
            });
        }
        
        function unblockFromSettings(uid, event) {
            event.stopPropagation();
            database.ref(`blockedUsers/${currentUser.uid}/${uid}`).remove().then(() => { showToast("Unblocked"); loadBlockedUsers(); loadDataFromFirebase(); });
        }
        
        function openChangePasswordModal() { closeModal('settingsModal'); document.getElementById('changePasswordModal').classList.add('active'); }
        function updatePassword() {
            const newPass = document.getElementById('newPassword').value;
            if (document.getElementById('oldPassword').value !== currentUser.password) return showToast('Incorrect old password');
            database.ref('users/' + currentUser.uid).update({ password: newPass }).then(() => {
                currentUser.password = newPass; localStorage.setItem('chatAppUser', JSON.stringify(currentUser));
                showToast('Updated'); closeModal('changePasswordModal');
            });
        }
        
        function openChangePhoneModal() { closeModal('settingsModal'); document.getElementById('changePhoneModal').classList.add('active'); document.getElementById('currentIdDisplay').textContent = currentUser.number; }
        function updatePhoneNumber() {
            const newPhone = selectedCountry.code + document.getElementById('newPhoneNumber').value.trim();
            if (document.getElementById('phoneChangePassword').value !== currentUser.password) return showToast('Incorrect password');
            database.ref('users').orderByChild('number').equalTo(newPhone).once('value').then(snapshot => {
                if (snapshot.exists()) return showToast('Number already used');
                database.ref('users/' + currentUser.uid).update({ number: newPhone }).then(() => {
                    currentUser.number = newPhone; localStorage.setItem('chatAppUser', JSON.stringify(currentUser));
                    closeModal('changePhoneModal'); showHomePage();
                });
            });
        }
        
        function showLanguageModal() { closeModal('settingsModal'); document.getElementById('languageModal').classList.add('active'); }
        function changeLanguage(langCode) {
            currentLanguage = langCode; localStorage.setItem('appLanguage', langCode);
            const texts = translations[langCode];
            document.querySelectorAll('[data-i18n]').forEach(el => { const key = el.getAttribute('data-i18n'); if (texts[key]) el.textContent = texts[key]; });
            if (langCode === 'ar' || langCode === 'ur') document.body.classList.add('rtl'); else document.body.classList.remove('rtl');
            closeModal('languageModal');
        }

        function showEditProfileModal() { document.getElementById('editProfileModal').classList.add('active'); document.getElementById('settingsModal').classList.remove('active'); document.getElementById('editProfileName').value = currentUser.name; document.getElementById('editPreview').src = currentUser.profilePic; }
        function updateProfile() {
            const name = document.getElementById('editProfileName').value;
            const updates = { name: name };
            if (uploadedImageBase64) updates.profilePic = uploadedImageBase64;
            database.ref('users/' + currentUser.uid).update(updates).then(() => {
                currentUser.name = name; if(uploadedImageBase64) currentUser.profilePic = uploadedImageBase64;
                localStorage.setItem('chatAppUser', JSON.stringify(currentUser)); showHomePage(); closeModal('editProfileModal');
            });
        }

        function closeModal(id) { document.getElementById(id).classList.remove('active'); }
        function showToast(msg) { const toast = document.getElementById('toast'); toast.innerText = msg; toast.classList.add('show'); setTimeout(() => toast.classList.remove('show'), 3000); }
        document.getElementById('messageInput').addEventListener('keypress', function (e) { if (e.key === 'Enter') sendMessage(); });
    </script>
</body>
</html>
